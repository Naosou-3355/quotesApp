<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0d0f1a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Our Quotes" />
  <title>QuoteApp</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.jpg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <!-- Chart.js loaded lazily when Stats tab is opened -->

  <style>
    /* â”€â”€ DESIGN TOKENS â”€â”€ */
    :root {
      --bg:          #0d0f1a;
      --surface:     #161a2e;
      --border:      #272c46;
      --border-glow: #7c6af744;

      --accent:      #7c6af7;
      --accent-dim:  #7c6af733;
      --accent-glow: 0 0 20px #7c6af755, 0 0 60px #7c6af722;
      --green:       #4ade80;
      --amber:       #fbbf24;
      --pink:        #f472b6;
      --cyan:        #22d3ee;

      --text:        #e8e6f4;
      --text-mid:    #9599b8;
      --text-dim:    #6d72a0;

      --font-mono:   'JetBrains Mono', 'Courier New', monospace;
      --font-body:   'DM Sans', system-ui, sans-serif;

      --radius:      14px;
      --radius-sm:   8px;
      --safe-top:    env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { overscroll-behavior: none; }
    * { -webkit-user-select: none; user-select: none; }
    input, textarea { -webkit-user-select: text; user-select: text; }

    html, body {
      height: 100%;
      font-family: var(--font-mono);
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
    }

    /* Scanline texture overlay â€” subtle, low perf impact */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.015) 2px,
        rgba(0,0,0,0.015) 4px
      );
      pointer-events: none;
      z-index: 100;
      will-change: auto;
    }

    /* â”€â”€ LAYOUT â”€â”€ */
    .app {
      display: flex;
      flex-direction: column;
      height: 100dvh;
      max-width: 480px;
      margin: 0 auto;
      background: var(--bg);
      position: relative;
      overflow: hidden;
    }

    /* â”€â”€ HEADER â”€â”€ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: calc(var(--safe-top) + 14px) 18px 14px;
      background: rgba(13,15,26,0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      position: relative;
      z-index: 10;
      flex-shrink: 0;
    }

    .app-name {
      font-family: var(--font-mono);
      font-size: 13px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .app-name::before {
      content: '// ';
      color: var(--text-dim);
      font-weight: 300;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-fav-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 7px 11px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: border-color 0.15s;
    }
    .btn-fav-header:active { border-color: var(--accent); }
    .btn-fav-header-icon {
      font-size: 15px;
      line-height: 1;
    }
    .btn-fav-header-label {
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-dim);
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    #fav-count-badge {
      color: var(--accent);
      font-weight: 600;
    }

    .icon-btn {
      width: 34px; height: 34px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-mid);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      transition: border-color 0.15s, color 0.15s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
      font-family: var(--font-mono);
    }
    .icon-btn:active { transform: scale(0.9); border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ SCREENS â”€â”€ */
    .screens-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      min-height: 0;
    }
    .screen {
      display: flex;
      flex-direction: column;
      position: absolute;
      inset: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.22s ease, visibility 0.22s;
      will-change: opacity;
    }
    .screen.active {
      opacity: 1;
      visibility: visible;
      z-index: 1;
    }

    /* â”€â”€ QUOTE SCREEN â”€â”€ */
    #screen-quote {
      padding: 0;
      justify-content: space-between;
    }

    /* â”€â”€ QUOTE AREA : layout fixe en 3 zones â”€â”€ */
    .quote-area {
      flex: 1;
      display: grid;
      grid-template-rows: 1fr auto;
      gap: 0;
      padding: 40px 28px 24px;
      min-height: 0;
      position: relative;
    }

    /* Coins dÃ©coratifs fixes */
    .quote-area::before, .quote-area::after {
      content: '';
      position: absolute;
      width: 20px; height: 20px;
      border-color: var(--border-glow);
      border-style: solid;
      pointer-events: none;
    }
    .quote-area::before { top: 20px; left: 18px; border-width: 2px 0 0 2px; }
    .quote-area::after  { bottom: 20px; right: 18px; border-width: 0 2px 2px 0; }

    /* Zone haute : numÃ©ro de phrase (fixe) */
    .quote-line-num {
      font-size: 11px;
      color: var(--text-dim);
      letter-spacing: 1px;
      font-family: var(--font-mono);
    }

    /* Zone centrale : " + texte (scrollable si nÃ©cessaire) */
    .quote-center {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 0;
      overflow: hidden;
    }

    .quote-mark {
      font-family: var(--font-mono);
      font-size: 48px;
      line-height: 0.7;
      color: var(--accent-dim);
      margin-bottom: 18px;
      display: block;
      font-weight: 700;
      flex-shrink: 0;
    }

    .quote-text {
      font-family: var(--font-body);
      font-size: clamp(16px, 4.5vw, 21px);
      line-height: 1.75;
      color: var(--text);
      font-weight: 300;
      font-style: italic;
      position: relative;
    }

    .cursor-blink {
      display: inline-block;
      width: 2px;
      height: 1.1em;
      background: var(--accent);
      margin-left: 3px;
      vertical-align: text-bottom;
      animation: blink 1s step-end infinite;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

    /* Zone basse : auteur + badges (fixe) */
    .quote-bottom {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    /* NumÃ©ro au-dessus du sÃ©parateur, alignÃ© Ã  droite */
    .quote-bottom .quote-line-num {
      text-align: right;
      padding-bottom: 6px;
      margin-bottom: 0;
    }

    /* SÃ©parateur + contenu infos */
    .quote-bottom-inner {
      padding-top: 10px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .quote-meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .meta-author {
      font-size: 12px;
      font-weight: 500;
      color: var(--accent);
      font-family: var(--font-mono);
      letter-spacing: 0.5px;
    }
    .meta-author::before { content: '> '; color: #ffffff; }

    .meta-secondary {
      font-size: 12px;
      color: var(--text-dim);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      font-family: var(--font-mono);
    }

    .meta-secondary span { display: flex; align-items: center; gap: 4px; }
    .meta-secondary span::before { content: 'â€”'; color: var(--text-dim); opacity: 0.4; }

    /* â”€â”€ CHIPS AREA â”€â”€ */
    .chips-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-start;
      min-height: 28px; /* rÃ©serve de la hauteur mÃªme vide */
    }

    /* Animation de transition entre phrases */
    @keyframes quoteOut {
      from { opacity: 1; transform: translateY(0); }
      to   { opacity: 0; transform: translateY(-6px); }
    }
    @keyframes quoteIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .quote-center.exiting, .quote-bottom.exiting {
      animation: quoteOut 0.18s ease-in forwards;
    }
    .quote-center.animating { animation: quoteIn 0.3s cubic-bezier(0.22,1,0.36,1) forwards; }
    .quote-bottom.animating { animation: quoteIn 0.3s cubic-bezier(0.22,1,0.36,1) 0.05s both; }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      font-size: 12px;
      font-weight: 400;
      font-family: var(--font-mono);
      color: var(--text-mid);
      cursor: pointer;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      letter-spacing: 0.3px;
    }
    .chip::before { content: '['; color: var(--text-dim); }
    .chip::after  { content: ']'; color: var(--text-dim); }
    .chip.active {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }
    .chip.active::before, .chip.active::after { color: var(--accent); }

    /* â”€â”€ BADGES TOUJOURS VISIBLES (catÃ©gorie + alcool) â”€â”€ */
    .info-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-family: var(--font-mono);
      font-weight: 500;
      letter-spacing: 0.3px;
      border: 1px solid var(--border);
    }
    .cat-badge {
      background: #6d1a2a18;
      color: #c0506a;
      border-color: #6d1a2a55;
    }
    .alc-badge.yes {
      background: #fbbf2414;
      color: var(--amber);
      border-color: #fbbf2440;
    }
    .alc-badge.no {
      background: #4ade8012;
      color: var(--green);
      border-color: #4ade8035;
    }

    /* â”€â”€ DETAILS PANEL â”€â”€ */
    .details-panel {
      display: none;
      flex-direction: column;
      gap: 8px;
      padding: 10px 0 0;
      animation: fadeIn 0.2s ease;
    }
    .details-panel.open { display: flex; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .detail-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 12px;
      font-family: var(--font-mono);
      line-height: 1.5;
    }
    .detail-label {
      color: #ffffff;
      flex-shrink: 0;
      font-size: 11px;
    }
    .detail-label::after { content: ':'; }
    .detail-value { color: var(--text-mid); }

    .alcohol-badge {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .alcohol-badge.yes { background: #fbbf2422; color: var(--amber); border: 1px solid #fbbf2444; }
    .alcohol-badge.no  { background: #4ade8022; color: var(--green);  border: 1px solid #4ade8044; }

    .vol-badge {
      background: #22d3ee18;
      color: #22d3ee;
      border: 1px solid #22d3ee33;
    }

    /* â”€â”€ BOTTOM ACTION BAR â”€â”€ */
    .bottom-bar {
      padding: 10px 16px calc(var(--safe-bottom) + 10px);
      display: flex;
      gap: 8px;
      align-items: center;
      border-top: 1px solid var(--border);
      background: rgba(13,15,26,0.95);
      backdrop-filter: blur(12px);
      flex-shrink: 0;
    }

    .btn-random {
      flex: 1;
      padding: 0 14px;
      height: 40px;
      border-radius: var(--radius);
      border: 1px solid var(--accent);
      background: var(--accent-dim);
      color: var(--accent);
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-random::before { content: ''; }
    .btn-random:active {
      transform: scale(0.98);
      background: var(--accent);
      color: var(--bg);
    }

    .btn-fav, .btn-filter-toggle {
      height: 40px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-mid);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      flex-shrink: 0;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 0 14px;
    }
    .btn-fav .fav-icon { font-size: 14px; line-height: 1; display: inline-block; }
    .btn-fav.pop .fav-icon {
      animation: favPop 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.49);
    }
    @keyframes favPop {
      0%   { transform: scale(1); }
      30%  { transform: scale(1.5); }
      60%  { transform: scale(0.85); }
      100% { transform: scale(1); }
    }
    .btn-fav:active, .btn-filter-toggle:active { transform: scale(0.95); }
    .btn-fav.active { border-color: #f472b644; background: #f472b611; color: #f472b6; }
    .btn-filter-toggle .filter-label { font-size: 10px; font-weight: 600; letter-spacing: 1px; }
    .btn-filter-toggle.active {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* â”€â”€ FILTER SCREEN â”€â”€ */
    #screen-filter { padding: 18px; gap: 18px; }

    .filter-section { display: flex; flex-direction: column; gap: 8px; }

    .filter-title {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
      font-family: var(--font-mono);
    }
    .filter-title::before { content: '// '; color: var(--border); }

    .filter-chips { display: flex; flex-wrap: wrap; gap: 6px; }

    .filter-search-wrap {
      position: relative;
      width: 100%;
    }
    .filter-search-wrap::before {
      content: 'ğŸ”';
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 13px;
      opacity: 0.5;
      pointer-events: none;
    }
    .filter-input {
      width: 100%;
      padding: 12px 14px 12px 38px;
      border-radius: 24px;
      border: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text);
      background: rgba(0,0,0,0.25);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      caret-color: var(--accent);
    }
    .filter-input::placeholder { color: var(--text-dim); font-size: 11px; }
    .filter-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
      background: rgba(0,0,0,0.35);
    }

    .filter-separator {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
      flex-shrink: 0;
    }



    /* â”€â”€ STATS SCREEN â”€â”€ */
    #screen-stats { padding: 18px; gap: 14px; }

    /* Stats filter banner â€” bottom only */
    .stats-banner-bottom {
      position: fixed;
      left: 50%;
      bottom: calc(var(--safe-bottom) + 70px);
      z-index: 200;
      background: rgba(13,15,26,0.5);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid #e05575;
      color: #e05575;
      padding: 9px 18px;
      border-radius: var(--radius);
      font-size: 11px;
      font-family: var(--font-mono);
      font-weight: 500;
      letter-spacing: 0.5px;
      white-space: nowrap;
      box-shadow: 0 0 10px rgba(224,85,117,0.15);
      pointer-events: none;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transform: translateX(-50%) translateY(20px);
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .stats-banner-bottom.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
      pointer-events: auto;
    }
    .stats-banner-bottom:active {
      transform: translateX(-50%) scale(0.95);
    }

    .chart-empty {
      text-align: center;
      padding: 28px 12px;
      color: var(--text-dim);
      font-size: 11px;
      font-family: var(--font-mono);
      letter-spacing: 0.5px;
    }
    .chart-empty::before {
      content: 'â—Œ';
      display: block;
      font-size: 22px;
      margin-bottom: 8px;
      opacity: 0.35;
    }

    .stat-grid-2 {
      grid-template-columns: 1fr 1fr;
    }

    /* Phrase du jour â€” clickable item in stats */
    .stat-daily-item {
      padding: 10px 12px;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: background 0.15s;
    }
    .stat-daily-item:active { background: rgba(124,106,247,0.08); }
    .stat-daily-quote {
      font-family: var(--font-body);
      font-size: 13px;
      font-style: italic;
      font-weight: 300;
      color: var(--text);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .stat-daily-author {
      font-size: 11px;
      color: var(--accent);
      font-family: var(--font-mono);
      margin-top: 6px;
    }
    .stat-daily-author span { color: var(--text-dim); }
    .stat-daily-empty {
      font-size: 11px;
      color: var(--text-dim);
      font-family: var(--font-mono);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .stat-daily-empty .daily-send-btn {
      flex-shrink: 0;
      background: none;
      border: 1px solid var(--accent);
      color: var(--accent);
      font-family: var(--font-mono);
      font-size: 10px;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      white-space: nowrap;
      letter-spacing: 0.3px;
    }
    .stat-daily-empty .daily-send-btn:active { opacity: 0.7; }

    /* Section separators */
    .stats-section-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 2.5px;
      font-family: var(--font-mono);
      padding: 8px 0 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .stats-section-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .stats-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
    }

    .stats-card-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-dim);
      margin-bottom: 14px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: var(--font-mono);
    }
    .stats-card-title::before { content: '// '; color: var(--border); }

    /* Overview: hero stat full width + 3 cols */
    .stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }

    .stat-mini {
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
    }
    .stat-mini.hero {
      grid-column: 1 / -1;
      padding: 18px 14px;
      background: rgba(124,106,247,0.06);
      border-color: rgba(124,106,247,0.2);
      justify-content: center;
    }
    .stat-mini.hero .num {
      font-size: 36px;
    }
    .stat-mini .num {
      font-size: 22px;
      font-weight: 700;
      color: var(--accent);
      font-family: var(--font-mono);
      line-height: 1.2;
      word-break: break-word;
      flex: 1;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      text-align: center;
      min-height: 0;
    }
    .stat-mini .lbl {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 6px;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-family: var(--font-mono);
      flex-shrink: 0;
    }

    /* Per-chart type heights */
    canvas.chart-canvas { max-height: 220px; }
    #chart-cats { max-height: 240px; margin-top: 8px; }
    #chart-hours { max-height: 180px; }
    #chart-locations { max-height: 240px; }


    /* â”€â”€ HISTORY SCREEN â”€â”€ */
    #screen-history { padding: 18px; gap: 10px; }
    #history-list {
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Swipe wrapper */
    .history-swipe {
      position: relative;
      overflow: hidden;
      border-radius: var(--radius-sm);
    }
    /* Swipe background layers */
    .history-swipe-bg {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      padding: 0 18px;
      font-size: 13px;
      font-family: var(--font-mono);
      letter-spacing: 0.5px;
      pointer-events: none;
    }
    .history-swipe-bg.bg-fav {
      background: rgba(244,114,182,0.12);
      justify-content: flex-start;
      color: #f472b6;
    }
    .history-swipe-bg.bg-del {
      background: rgba(239,68,68,0.12);
      justify-content: flex-end;
      color: #ef4444;
    }

    .history-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 16px;
      cursor: pointer;
      position: relative;
      transition: transform 0.2s ease, opacity 0.3s;
      touch-action: pan-y;
    }
    /* HiÃ©rarchie visuelle */
    .history-item[data-rank="0"],
    .history-item[data-rank="1"],
    .history-item[data-rank="2"] { opacity: 1; }
    .history-item[data-rank="3"],
    .history-item[data-rank="4"],
    .history-item[data-rank="5"] { opacity: 0.85; }
    .history-item[data-rank="6"],
    .history-item[data-rank="7"],
    .history-item[data-rank="8"],
    .history-item[data-rank="9"] { opacity: 0.7; }
    .history-item[data-rank="10"],
    .history-item[data-rank="11"],
    .history-item[data-rank="12"],
    .history-item[data-rank="13"],
    .history-item[data-rank="14"] { opacity: 0.55; }
    .history-item[data-rank="15"],
    .history-item[data-rank="16"],
    .history-item[data-rank="17"],
    .history-item[data-rank="18"],
    .history-item[data-rank="19"] { opacity: 0.42; }
    /* Premier item â€” accent border */
    .history-item[data-rank="0"] { border-color: rgba(124,106,247,0.3); }
    /* Favori â€” subtle left accent bar */
    .history-item.is-fav { border-left: 3px solid #f472b6; }

    .history-item:active { border-color: var(--accent); opacity: 1; }
    .history-item-body { flex: 1; min-width: 0; }
    .history-quote {
      font-family: var(--font-body);
      font-size: 14px;
      font-style: italic;
      font-weight: 300;
      color: var(--text);
      line-height: 1.6;
    }
    .history-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 6px;
      gap: 6px;
    }
    .history-author {
      font-size: 12px;
      color: var(--text-dim);
      font-family: var(--font-mono);
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px;
      flex: 1;
      min-width: 0;
    }
    .history-author-arrow { color: var(--accent); margin-right: 2px; }
    .history-time {
      font-size: 10px;
      color: var(--text-dim);
      font-family: var(--font-mono);
      opacity: 0.6;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .history-cat-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 3px;
      font-size: 10px;
      background: #6d1a2a18;
      color: #c0506a;
      border: 1px solid #c0506a33;
      font-style: normal;
      white-space: nowrap;
    }
    /* Swipe remove animation */
    .history-swipe.removing {
      max-height: 200px;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }
    .history-swipe.removing.gone {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      margin: 0;
    }
    /* Empty state animation */
    .empty-state .empty-icon {
      font-size: 40px;
      opacity: 0.5;
      animation: emptyPulse 3s ease-in-out infinite;
    }
    @keyframes emptyPulse {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.1); }
    }

    /* â”€â”€ BOTTOM NAV â”€â”€ */
    .bottom-nav {
      display: flex;
      border-top: 1px solid var(--border);
      background: rgba(13,15,26,0.97);
      padding-bottom: max(4px, calc(var(--safe-bottom) - 12px));
      flex-shrink: 0;
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 10px 0 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      transition: color 0.15s;
      -webkit-tap-highlight-color: transparent;
      position: relative;
    }
    .nav-btn .nav-icon { font-size: 18px; line-height: 1; }
    .nav-btn.active { color: var(--accent); }
    .nav-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0; left: 25%; right: 25%;
      height: 2px;
      background: var(--accent);
      border-radius: 1px;
      box-shadow: 0 0 8px var(--accent);
    }

    /* â”€â”€ EMPTY STATE â”€â”€ */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--text-dim);
      padding: 40px;
      text-align: center;
      font-family: var(--font-mono);
    }
    .empty-state .empty-icon { font-size: 40px; opacity: 0.5; }
    .empty-state p { font-size: 12px; line-height: 1.8; }

    /* â”€â”€ MODAL / SHEET â”€â”€ */
    .sheet-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.18);
      z-index: 100;
      backdrop-filter: blur(4px);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.45s ease;
    }
    .sheet-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .sheet {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      background: var(--surface);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 18px 18px 0 0;
      padding: 18px 18px calc(var(--safe-bottom) + 22px);
      transform: translateY(100%);
      transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
      will-change: transform;
      max-height: 65vh;
      display: flex;
      flex-direction: column;
      touch-action: none;
    }
    .sheet-overlay.open .sheet {
      transform: translateY(0);
    }

    @keyframes sheetUp {
      from { transform: translateY(100%); }
      to   { transform: translateY(0); }
    }

    .sheet-handle {
      width: 32px; height: 3px;
      background: var(--border);
      border-radius: 2px;
      margin: 14px auto 10px;
      cursor: grab;
    }

    .sheet-title {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
      font-family: var(--font-mono);
      margin-bottom: 14px;
    }
    .sheet-title::before { content: '// '; color: var(--border); }

    .sheet-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      overflow-y: auto;
    }

    .sheet-item {
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface);
      font-size: 13px;
      font-family: var(--font-body);
      font-style: italic;
      font-weight: 300;
      cursor: pointer;
      transition: all 0.12s;
      line-height: 1.5;
      color: var(--text);
    }
    .sheet-item:active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ DATA LOAD SCREEN â”€â”€ */
    .load-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 18px;
      padding: 32px 24px;
      text-align: center;
    }

    .load-title {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--text-dim);
      font-family: var(--font-mono);
    }
    .load-title::before { content: '// '; color: var(--border); }

    .load-spinner {
      display: none;
    }

    .skeleton-quote {
      width: 100%;
      max-width: 340px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 0 24px;
    }
    .skeleton-bar {
      height: 14px;
      border-radius: 6px;
      background: linear-gradient(90deg, var(--border) 25%, var(--surface) 50%, var(--border) 75%);
      background-size: 200% 100%;
      animation: skeletonShimmer 1.5s ease infinite;
    }
    .skeleton-bar:nth-child(1) { width: 90%; }
    .skeleton-bar:nth-child(2) { width: 75%; }
    .skeleton-bar:nth-child(3) { width: 60%; }
    .skeleton-bar:nth-child(4) { width: 40%; margin-top: 8px; height: 10px; opacity: 0.5; }
    @keyframes skeletonShimmer {
      0%   { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ TOAST â”€â”€ */
    .toast {
      position: fixed;
      top: calc(var(--safe-top) + 62px);
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
      background: #1e2140;
      border: 1px solid var(--accent);
      color: var(--text);
      padding: 9px 18px;
      border-radius: var(--radius);
      font-size: 11px;
      font-family: var(--font-mono);
      font-weight: 500;
      letter-spacing: 0.5px;
      opacity: 0;
      transition: opacity 0.25s ease, transform 0.25s ease;
      pointer-events: none;
      white-space: nowrap;
      z-index: 200;
      box-shadow: 0 4px 20px rgba(0,0,0,0.45), 0 0 10px var(--accent-dim);
    }
    .toast::before { content: '> '; color: var(--accent); font-weight: 700; }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* â”€â”€ PWA INSTALL PROMPT â€” centered overlay, LOG item style â”€â”€ */
    .pwa-install-overlay {
      position: fixed;
      inset: 0;
      z-index: 210;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .pwa-install-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }
    .pwa-install-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 14px 12px 16px;
      max-width: 320px;
      width: calc(100% - 48px);
      transform: scale(0.92) translateY(10px);
      transition: transform 0.3s ease;
    }
    .pwa-install-overlay.show .pwa-install-card {
      transform: scale(1) translateY(0);
    }
    .pwa-install-card .pwa-quote {
      font-family: var(--font-body);
      font-size: 14px;
      font-style: italic;
      font-weight: 300;
      color: var(--text);
      line-height: 1.6;
      margin-bottom: 8px;
    }
    .pwa-install-card .pwa-author {
      font-size: 12px;
      color: var(--text-dim);
      font-family: var(--font-mono);
      margin-bottom: 14px;
    }
    .pwa-install-card .pwa-author span { color: var(--accent); }
    .pwa-install-card .pwa-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .pwa-install-card .pwa-dismiss {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 10px;
      padding: 6px 14px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      letter-spacing: 0.5px;
      flex-shrink: 0;
    }
    .pwa-install-card .pwa-dismiss:active { opacity: 0.7; }
    .pwa-install-card .pwa-check-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: var(--text-dim);
      font-family: var(--font-mono);
      cursor: pointer;
      user-select: none;
    }
    .pwa-install-card .pwa-check-label input {
      accent-color: var(--accent);
      width: 13px;
      height: 13px;
      cursor: pointer;
    }

    /* â”€â”€ PWA UPDATE BANNER â”€â”€ */
    .pwa-update-banner {
      position: fixed;
      top: calc(var(--safe-top) + 62px);
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      z-index: 210;
      background: #1e2140;
      border: 1px solid #4ade80;
      border-radius: var(--radius);
      padding: 10px 18px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text);
      white-space: nowrap;
      box-shadow: 0 4px 20px rgba(0,0,0,0.45), 0 0 10px rgba(74,222,128,0.2);
      opacity: 0;
      pointer-events: none;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .pwa-update-banner.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }
    .pwa-update-banner:active { transform: translateX(-50%) scale(0.95); }

    /* â”€â”€ SCROLLBAR â”€â”€ */
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* â”€â”€ No data overlay â”€â”€ */
    #no-data-screen { z-index: 2; }
    #no-data-screen:not(.active) { pointer-events: none; }

    /* â”€â”€ ANIMATIONS â”€â”€ */
    @keyframes glitch {
      0%,100% { transform: translate(0); }
      20%      { transform: translate(-2px, 1px); }
      40%      { transform: translate(2px, -1px); }
      60%      { transform: translate(-1px, 2px); }
      80%      { transform: translate(1px, -2px); }
    }
    .quote-text.loading { animation: glitch 0.3s ease; opacity: 0.1; }

    /* â”€â”€ BOUTON FILTRE BOTTOM BAR â”€â”€ */
    /* â”€â”€ FILTER OVERLAY â”€â”€ */
    .filter-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.18);
      z-index: 100;
      backdrop-filter: blur(4px);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.45s ease;
    }
    .filter-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    /* Le panneau occupe 65vh max, slide up/down */
    .filter-menu {
      width: 100%;
      max-width: 480px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 18px 18px 0 0;
      display: flex;
      flex-direction: column;
      height: 65vh;
      transform: translateY(100%);
      transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1);
      will-change: transform;
      touch-action: none;
    }
    .filter-overlay.open .filter-menu {
      transform: translateY(0);
    }

    /* Header fixe en haut, ne scroll pas */
    .filter-menu-header {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px 12px;
      border-bottom: 1px solid var(--border);
    }

    .filter-count-txt {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      font-family: var(--font-mono);
      letter-spacing: 0.5px;
    }

    .filter-reset {
      padding: 7px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 12px;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
      white-space: nowrap;
    }
    .filter-reset:hover { border-color: var(--border); color: var(--text-dim); }
    .filter-reset:active { border-color: var(--border); color: var(--text-dim); }
    .filter-reset.has-filters { border-color: #e05575; color: #e05575; }
    .filter-reset.has-filters:hover { background: #e0557520; border-color: #e05575; color: #e05575; }

    /* Body scrollable â€” prend tout l'espace restant */
    .filter-menu-body {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      padding: 10px 14px calc(var(--safe-bottom) + 24px);
      display: flex;
      flex-direction: column;
      gap: 10px;
      /* On laisse les enfants dÃ©finir leur propre hauteur â€” pas de overflow:hidden sur eux */
    }

    /* â”€â”€ CATÃ‰GORIES PLIABLES â”€â”€ */
    .filter-cat-section {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      flex-shrink: 0;
      contain: layout style;
    }

    .filter-cat-toggle {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 14px;
      background: var(--surface);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-mid);
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: color 0.15s, background 0.15s;
      letter-spacing: 0.3px;
    }
    .filter-cat-toggle:active { color: var(--accent); }
    .filter-cat-toggle.has-active { color: var(--accent); background: var(--accent-dim); }
    .filter-cat-toggle.open { border-radius: var(--radius-sm) var(--radius-sm) 0 0; }

    .filter-cat-arrow {
      font-size: 10px;
      transition: transform 0.2s;
      color: var(--text-dim);
      flex-shrink: 0;
    }
    .filter-cat-toggle.open .filter-cat-arrow { transform: rotate(90deg); }

    /* Contenu pliable â€” grid-template-rows for smooth height animation */
    .filter-collapsible {
      display: grid;
      grid-template-rows: 0fr;
      transition: grid-template-rows 0.25s ease-out;
    }
    .filter-collapsible > .filter-chips-inner {
      min-height: 0;
      overflow: hidden;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 0 12px;
      background: var(--surface);
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    }
    .filter-collapsible.open {
      grid-template-rows: 1fr;
    }
    .filter-collapsible.open > .filter-chips-inner {
      padding: 10px 12px 12px;
    }


  </style>
</head>
<body>

<div class="app" id="app">

  <!-- HEADER -->
  <header class="header">
    <span class="app-name" id="app-title">our quotes</span>
    <div class="header-actions">
      <button class="btn-fav-header" id="btn-fav-header" onclick="openHistorySheet()" title="Mes favoris" aria-label="Ouvrir les favoris">
        <span class="btn-fav-header-label">Mes phrases prÃ©fs<span id="fav-count-badge"></span></span>
        <span class="btn-fav-header-icon">ğŸ¤</span>
      </button>
    </div>
  </header>

  <div class="screens-container">

  <!-- SCREEN : DATA LOAD -->
  <div class="screen active" id="no-data-screen">
    <div class="load-area">
      <div class="skeleton-quote">
        <div class="skeleton-bar"></div>
        <div class="skeleton-bar"></div>
        <div class="skeleton-bar"></div>
        <div class="skeleton-bar"></div>
      </div>
      <div class="load-title">loading data.json</div>
    </div>
  </div>

  <!-- SCREEN : QUOTE -->
  <div class="screen" id="screen-quote">
    <div class="quote-area">

      <!-- Zone centrale : citation -->
      <div class="quote-center" id="quote-center">
        <span class="quote-mark">"</span>
        <p class="quote-text" id="quote-text">Appuyez sur le bouton pour dÃ©couvrir une phrase.<span class="cursor-blink"></span></p>
      </div>

      <!-- Zone basse : auteur + badges + contexte -->
      <div class="quote-bottom" id="quote-bottom">
        <div class="quote-line-num" id="quote-line-num">phrase 001 / 000</div>
        <div class="quote-bottom-inner">
          <div class="quote-meta">
            <div class="meta-author" id="meta-author">â€”</div>
            <div class="meta-secondary" id="meta-secondary"></div>
          </div>
          <!-- Badges : Volume > CatÃ©gorie > Alcool > Voir contexte -->
          <div class="chips-row" id="chips-row"></div>
          <!-- DÃ©tails panel -->
          <div class="details-panel" id="details-panel"></div>
        </div>
      </div>

    </div>


    <!-- Bottom bar -->
    <div class="bottom-bar">
      <button class="btn-fav" id="btn-fav" onclick="toggleFav()" title="Ajouter aux favoris" aria-label="Ajouter aux favoris">
        <span class="fav-icon">ğŸ“Œ</span>
      </button>
      <button class="btn-random" onclick="showRandom()" aria-label="Afficher une citation alÃ©atoire">MÃ©nestrel, une autre</button>
      <button class="btn-filter-toggle" id="btn-filter-toggle" title="Filtres" aria-label="Ouvrir les filtres"><span class="filter-icon">ğŸ”</span> <span class="filter-label">Filtrer</span></button>
    </div>
  </div>


  <!-- SCREEN : STATS -->
  <div class="screen" id="screen-stats">
    <div class="stats-banner-bottom" id="stats-banner-bottom" onclick="clearStatsFilter()">ğŸ§¹ Supprimer les filtres</div>
    <div class="stats-card">
      <div class="stats-card-title">overview</div>
      <div class="stat-grid" id="stat-overview"></div>
    </div>
    <div class="stats-card">
      <div class="stats-card-title">phrase du jour</div>
      <div id="stat-daily"></div>
    </div>

    <div class="stats-section-label">rÃ©partition</div>

    <div class="stats-card" id="card-persons">
      <div class="stats-card-title">phrases par personne</div>
      <canvas class="chart-canvas" id="chart-persons"></canvas>
      <div class="chart-empty" style="display:none"></div>
    </div>
    <div class="stats-card" id="card-cats">
      <div class="stats-card-title">catÃ©gories</div>
      <canvas class="chart-canvas" id="chart-cats"></canvas>
      <div class="chart-empty" style="display:none"></div>
    </div>

    <div class="stats-section-label">activitÃ©</div>

    <div class="stats-card" id="card-hours">
      <div class="stats-card-title">activitÃ© par heure</div>
      <canvas class="chart-canvas" id="chart-hours"></canvas>
      <div class="chart-empty" style="display:none"></div>
    </div>
    <div class="stats-card" id="card-locations">
      <div class="stats-card-title">top lieux (hors Paris)</div>
      <canvas class="chart-canvas" id="chart-locations"></canvas>
      <div class="chart-empty" style="display:none"></div>
    </div>
    <div class="stats-card" id="card-volumes">
      <div class="stats-card-title">phrases par volume</div>
      <canvas class="chart-canvas" id="chart-volumes"></canvas>
      <div class="chart-empty" style="display:none"></div>
    </div>
  </div>

  <!-- SCREEN : HISTORY -->
  <div class="screen" id="screen-history">
    <div class="empty-state" id="history-empty">
      <div class="empty-icon">ğŸ²</div>
      <p>// aucun historique<br>tirez des phrases pour les<br>voir apparaÃ®tre ici<br><br><span style="color:var(--accent);font-size:10px">â† swipe droite = favori Â· swipe gauche = supprimer â†’</span></p>
    </div>
    <div id="history-list"></div>
  </div>

  </div><!-- /.screens-container -->

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav" id="bottom-nav">
    <button class="nav-btn active" onclick="navigate('quote')" id="nav-quote" aria-label="Phrases alÃ©atoires">
      <span class="nav-icon">ğŸ²</span>phrases
    </button>
    <button class="nav-btn" onclick="navigate('stats')" id="nav-stats" aria-label="Statistiques">
      <span class="nav-icon">ğŸ“Š</span>stats
    </button>
    <button class="nav-btn" onclick="navigate('history')" id="nav-history" aria-label="Historique de session">
      <span class="nav-icon">ğŸ’¾</span>historique
    </button>
  </nav>

</div>


<!-- FILTER MENU OVERLAY -->
<div class="filter-overlay" id="filter-overlay" onclick="closeFilterMenu(event)" role="dialog" aria-label="Panneau de filtres">
  <div class="filter-menu" id="filter-menu">
    <div class="sheet-handle"></div>
    <div class="filter-menu-header">
      <div class="filter-count-txt" id="filter-count">â€” phrases</div>
      <button class="filter-reset" onclick="resetFilters()" aria-label="Supprimer tous les filtres">ğŸ§¹ Supprimer les filtres</button>
    </div>
    <div class="filter-menu-body">
      <div class="filter-search-wrap">
        <input class="filter-input" type="search" placeholder="Rechercher une citationâ€¦" id="search-input" oninput="applyFilters()" aria-label="Rechercher dans les citations" />
      </div>
      <div class="filter-separator"></div>
      <div class="filter-cat-section">
        <button class="filter-cat-toggle" onclick="toggleFilterCat('authors')">
          <span>ğŸ‘¤ Auteur</span><span class="filter-cat-arrow">â–¸</span>
        </button>
        <div class="filter-collapsible" id="filter-authors"><div class="filter-chips-inner"></div></div>
      </div>
      <div class="filter-cat-section">
        <button class="filter-cat-toggle" onclick="toggleFilterCat('main-cats')">
          <span>ğŸ· CatÃ©gorie principale</span><span class="filter-cat-arrow">â–¸</span>
        </button>
        <div class="filter-collapsible" id="filter-main-cats"><div class="filter-chips-inner"></div></div>
      </div>
      <div class="filter-cat-section">
        <button class="filter-cat-toggle" onclick="toggleFilterCat('second-cats')">
          <span>ğŸ”– CatÃ©gorie secondaire</span><span class="filter-cat-arrow">â–¸</span>
        </button>
        <div class="filter-collapsible" id="filter-second-cats"><div class="filter-chips-inner"></div></div>
      </div>
      <div class="filter-cat-section">
        <button class="filter-cat-toggle" onclick="toggleFilterCat('locations')">
          <span>ğŸ“ Lieu</span><span class="filter-cat-arrow">â–¸</span>
        </button>
        <div class="filter-collapsible" id="filter-locations"><div class="filter-chips-inner"></div></div>
      </div>
      <div class="filter-cat-section">
        <button class="filter-cat-toggle" onclick="toggleFilterCat('alcohol')">
          <span>ğŸº Alcool</span><span class="filter-cat-arrow">â–¸</span>
        </button>
        <div class="filter-collapsible" id="filter-alcohol"><div class="filter-chips-inner"></div></div>
      </div>
      <div class="filter-cat-section">
        <button class="filter-cat-toggle" onclick="toggleFilterCat('volumes')">
          <span>ğŸ“š Volume</span><span class="filter-cat-arrow">â–¸</span>
        </button>
        <div class="filter-collapsible" id="filter-volumes"><div class="filter-chips-inner"></div></div>
      </div>
    </div>
  </div>
</div>

<!-- FAVORITES SHEET -->
<div class="sheet-overlay" id="history-sheet" onclick="closeHistorySheet(event)" role="dialog" aria-label="Favoris">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">favoris</div>
    <div class="sheet-list" id="fav-list"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- PWA INSTALL PROMPT -->
<div class="pwa-install-overlay" id="pwa-install-overlay">
  <div class="pwa-install-card">
    <div class="pwa-quote">Pour installer l'application, appuyez sur Partager â†’ Sur l'Ã©cran d'accueil</div>
    <div class="pwa-author"><span>></span> our quotes Â· installation</div>
    <div class="pwa-actions">
      <label class="pwa-check-label">
        <input type="checkbox" id="pwa-noremind">
        Ne plus me le rappeler
      </label>
      <button class="pwa-dismiss" onclick="dismissInstallBanner()">OK, compris</button>
    </div>
  </div>
</div>

<!-- PWA UPDATE BANNER -->
<div class="pwa-update-banner" id="pwa-update-banner">
  ğŸ†• Nouvelle version disponible â€” appuyez pour mettre Ã  jour
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const App = {
  allQuotes: [],
  filteredQuotes: [],
  currentQuote: null,
  sessionHistory: [],
  favorites: JSON.parse(localStorage.getItem('qapp_favs') || '[]'),
  activeFilters: { authors:[], mainCats:[], secondCats:[], locations:[], alcohol:[], volumes:[], search:'' },
  charts: {},
  dataLoaded: false,
  shuffleQueue: [],
  chartJsLoaded: false,
  toastTimer: null,
  statsDirty: true,
};

// Shorthand aliases for readability in hot paths
const { activeFilters } = App;

// â”€â”€ XSS Protection â”€â”€
function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = String(str);
  return d.innerHTML;
}

// â”€â”€ Unique quote identifier (avoids collisions on identical text) â”€â”€
function quoteId(q) {
  return getCol(q, COL.quote) + '|||' + getCol(q, COL.name) + '|||' + getCol(q, COL.ts);
}

// Column mapping (flexible)
const COL = {
  ts:        ['date','Horodateur','horodateur','timestamp'],
  quote:     ['q','Insert quote','insert quote','Quote','quote','phrase'],
  name:      ['name','Insert name (e.g: John. D)','Insert name','auteur','Auteur'],
  location:  ['loc','Insert location','Location','lieu','Lieu'],
  mainCat:   ['cat1','Main category','main category','CatÃ©gorie principale'],
  secondCat: ['cat2','Second category','second category','CatÃ©gorie secondaire'],
  alcohol:   ['alc','Under alcohol ?','Under alcohol','alcool','Alcool'],
  context:   ['ctx','Context','context','Contexte'],
  wam:       ['wam','Si wam, avec qui ?','Si wam'],
  volume:    ['vol','Volume','volume','Vol'],
};

function getCol(row, keys) {
  for (const k of keys) {
    if (row[k] !== undefined && row[k] !== null && row[k] !== '') return row[k];
  }
  // Case insensitive fallback
  const rowLower = Object.fromEntries(Object.entries(row).map(([k,v])=>[k.toLowerCase(),v]));
  for (const k of keys) {
    if (rowLower[k.toLowerCase()] !== undefined) return rowLower[k.toLowerCase()];
  }
  return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATE PARSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseDate(str) {
  if (!str) return null;
  str = String(str).trim();
  let m;
  // DD/MM/YYYY HH:MM:SS or DD/MM/YYYY HH:MM
  m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})[\s,T](\d{2}):(\d{2})/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1], +m[4], +m[5]);
  // DD/MM/YYYY (no time)
  m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1]);
  // DD-MM-YYYY or DD.MM.YYYY with optional time
  m = str.match(/^(\d{1,2})[-.](\d{1,2})[-.](\d{4})(?:[\s,T](\d{2}):(\d{2}))?/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1], +(m[4]||0), +(m[5]||0));
  // YYYY-MM-DD (ISO short) with optional time
  m = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})(?:[\s,T](\d{2}):(\d{2}))?/);
  if (m) return new Date(+m[1], +m[2]-1, +m[3], +(m[4]||0), +(m[5]||0));
  // Google Sheets timestamp (number of days since 1899-12-30)
  if (/^\d{5}(\.\d+)?$/.test(str)) {
    const epoch = new Date(1899, 11, 30);
    return new Date(epoch.getTime() + parseFloat(str) * 86400000);
  }
  // Fallback: native Date parser
  const d = new Date(str);
  return isNaN(d.getTime()) ? null : d;
}

function formatDate(str) {
  const d = parseDate(str);
  if (!d) return str;
  return d.toLocaleDateString('fr-FR', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA LOADING â€” fetch depuis GitHub Pages
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Charge data.json automatiquement au dÃ©marrage (chemin relatif GitHub Pages)
async function fetchData() {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 10000); // 10s timeout
  try {
    const res = await fetch('./data.json', { signal: controller.signal });
    clearTimeout(timeout);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    initData(Array.isArray(data) ? data : data.data || []);
  } catch (err) {
    clearTimeout(timeout);
    console.warn('data.json introuvable ou invalide :', err);
    showLoadError(err.name === 'AbortError'
      ? 'Timeout â€” le chargement prend trop de temps.'
      : 'Impossible de charger data.json. VÃ©rifiez votre dÃ©ploiement.');
  }
}

function showLoadError(msg) {
  const screen = document.getElementById('no-data-screen');
  const area = screen.querySelector('.load-area');
  if (!area) return;
  area.innerHTML =
    '<div style="font-size:32px;opacity:0.5">âš </div>' +
    '<div class="load-title">' + esc(msg) + '</div>' +
    '<button onclick="location.reload()" style="margin-top:8px;padding:10px 20px;border-radius:var(--radius-sm);border:1px solid var(--accent);background:var(--accent-dim);color:var(--accent);font-family:var(--font-mono);font-size:12px;cursor:pointer;letter-spacing:1px">â†» RÃ©essayer</button>';
}

function initData(data) {
  App.allQuotes = data.filter(r => getCol(r, COL.quote));
  App.filteredQuotes = [...App.allQuotes];
  App.dataLoaded = true;

  // Restore history from localStorage â€” supports {q,ts} and legacy raw arrays
  try {
    const saved = JSON.parse(localStorage.getItem('qapp_history') || '[]');
    App.sessionHistory = saved.slice(0, 20).map(entry => {
      if (entry && entry.ts !== undefined && entry.q) return entry; // new format {q, ts}
      return { q: entry, ts: 0 }; // legacy: raw quote row, no timestamp
    });
  } catch(e) { App.sessionHistory = []; }

  document.getElementById('no-data-screen').classList.remove('active');
  document.getElementById('bottom-nav').style.display = '';
  navigate('quote');
  buildFilters();
  buildQueue();
  showRandom();
  updateFavCount();
  showToast(`${App.allQuotes.length} phrases chargÃ©es`);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hideAllScreens() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
}

function navigate(screen) {
  if (!App.dataLoaded && screen !== 'load') return;
  hideAllScreens();
  document.getElementById('screen-' + screen).classList.add('active');
  const navBtn = document.getElementById('nav-' + screen);
  if (navBtn) navBtn.classList.add('active');

  // Show/hide stats banner depending on active screen
  const bannerBottom = document.getElementById('stats-banner-bottom');
  if (screen !== 'stats') {
    bannerBottom.classList.remove('show');
  }

  if (screen === 'stats') buildStats();
  if (screen === 'history') renderHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUOTE DISPLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// File de lecture mÃ©langÃ©e : chaque phrase est jouÃ©e une fois avant de recommencer
// App.shuffleQueue is in App.shuffleQueue

function buildQueue() {
  // Fisher-Yates shuffle sur une copie de App.filteredQuotes
  App.shuffleQueue = [...App.filteredQuotes];
  for (let i = App.shuffleQueue.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [App.shuffleQueue[i], App.shuffleQueue[j]] = [App.shuffleQueue[j], App.shuffleQueue[i]];
  }
}

function showRandom() {
  if (!App.filteredQuotes.length) {
    showToast('Aucune phrase avec ces filtres');
    return;
  }
  if (!App.shuffleQueue.length) { buildQueue(); }
  displayQuote(App.shuffleQueue.pop());
}

function displayQuote(q) {
  App.currentQuote = q;

  const centerEl = document.getElementById('quote-center');
  const bottomEl = document.getElementById('quote-bottom');

  // Content update function (called after exit or immediately on first load)
  function applyContent() {
    // NumÃ©ro de phrase
    const qIdx = App.filteredQuotes.indexOf(q) + 1 || '?';
    const lineEl = document.getElementById('quote-line-num');
    if (lineEl) lineEl.textContent = 'phrase ' + String(qIdx).padStart(3,'0') + ' / ' + String(App.filteredQuotes.length).padStart(3,'0');

    const el = document.getElementById('quote-text');
    el.innerHTML = esc(getCol(q, COL.quote)) + '<span class="cursor-blink"></span>';

    const name = getCol(q, COL.name);
    const loc  = getCol(q, COL.location);
    const ts   = getCol(q, COL.ts);

    document.getElementById('meta-author').textContent = name ? 'â€” ' + name : 'â€”';

    const secEl = document.getElementById('meta-secondary');
    secEl.innerHTML = '';
    if (loc) secEl.innerHTML += '<span>' + esc(loc) + '</span>';
    if (ts)  secEl.innerHTML += '<span>' + esc(formatDate(ts)) + '</span>';

    buildChips(q);

    // Enter animation
    centerEl.classList.remove('exiting');
    bottomEl.classList.remove('exiting');
    centerEl.classList.remove('animating');
    bottomEl.classList.remove('animating');
    void centerEl.offsetWidth;
    centerEl.classList.add('animating');
    bottomEl.classList.add('animating');
  }

  // If already displaying content, do exit â†’ enter crossfade
  const hasContent = document.getElementById('quote-text').textContent.length > 40;
  if (hasContent) {
    centerEl.classList.remove('animating', 'exiting');
    bottomEl.classList.remove('animating', 'exiting');
    void centerEl.offsetWidth;
    centerEl.classList.add('exiting');
    bottomEl.classList.add('exiting');
    setTimeout(applyContent, 180);
  } else {
    applyContent();
  }

  // Add to history (limit 20, persist with timestamp)
  App.sessionHistory.unshift({ q: q, ts: Date.now() });
  if (App.sessionHistory.length > 20) App.sessionHistory.length = 20;
  localStorage.setItem('qapp_history', JSON.stringify(App.sessionHistory));

  // Fav state
  updateFavBtn();
}

function buildChips(q) {
  const row   = document.getElementById('chips-row');
  const panel = document.getElementById('details-panel');
  row.innerHTML   = '';
  panel.innerHTML = '';
  panel.classList.remove('open');

  const ctx       = getCol(q, COL.context);
  const mainCat   = getCol(q, COL.mainCat);
  const secondCat = getCol(q, COL.secondCat);
  const alcohol   = getCol(q, COL.alcohol);
  const volume    = getCol(q, COL.volume);

  if (!ctx && !mainCat && !secondCat && !alcohol && !volume) return;

  // â”€â”€ Badge Volume (seul badge visible) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (volume) {
    const badge = document.createElement('span');
    badge.className = 'info-badge vol-badge';
    badge.textContent = 'ğŸ“š ' + volume;
    row.appendChild(badge);
  }

  // â”€â”€ Bouton "voir le contexte" (si contexte, catÃ©gorie ou alcool dispo) â”€â”€
  const hasDetails = ctx || mainCat || secondCat || alcohol;
  if (hasDetails) {
    const masterChip = document.createElement('button');
    masterChip.className = 'chip';
    masterChip.innerHTML = `<span>â†“</span> voir le contexte`;
    masterChip.onclick = () => {
      const open = panel.classList.toggle('open');
      masterChip.classList.toggle('active', open);
      masterChip.innerHTML = open
        ? `<span>â†‘</span> masquer`
        : `<span>â†“</span> voir le contexte`;
    };
    row.appendChild(masterChip);

    // â”€â”€ Panel : badges catÃ©gorie/alcool, puis contexte texte â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const hasBadges = mainCat || alcohol;
    if (hasBadges) {
      const badgeRow = document.createElement('div');
      badgeRow.className = 'chips-row';
      badgeRow.style.cssText = 'margin-bottom:8px;';
      if (mainCat) {
        const cat = mainCat + (secondCat ? ' Â· ' + secondCat : '');
        const b = document.createElement('span');
        b.className = 'info-badge cat-badge';
        b.textContent = cat;
        badgeRow.appendChild(b);
      }
      if (alcohol) {
        const isYes = /oui|yes|true/i.test(alcohol);
        const b = document.createElement('span');
        b.className = 'info-badge alc-badge ' + (isYes ? 'yes' : 'no');
        b.textContent = isYes ? 'ğŸº avec alcool' : 'ğŸƒ sans alcool';
        badgeRow.appendChild(b);
      }
      panel.appendChild(badgeRow);
    }
    if (ctx) {
      const r = document.createElement('div');
      r.className = 'detail-row';
      r.innerHTML = `<span class="detail-label">Contexte</span><span class="detail-value">${esc(ctx)}</span>`;
      panel.appendChild(r);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FAVORITES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Shared favorite toggle helper â”€â”€
function setFavorite(q) {
  const qid = quoteId(q);
  const idx = App.favorites.findIndex(f => quoteId(f) === qid);
  const added = idx === -1;
  if (added) {
    App.favorites.push(q);
  } else {
    App.favorites.splice(idx, 1);
  }
  localStorage.setItem('qapp_favs', JSON.stringify(App.favorites));
  updateFavBtn();
  showToast(added ? 'â™¥ï¸ AjoutÃ© aux favoris' : 'ğŸ’” RetirÃ© des favoris');
  return added;
}

function toggleFav() {
  if (!App.currentQuote) return;
  setFavorite(App.currentQuote);
  // Trigger pop animation
  const btn = document.getElementById('btn-fav');
  btn.classList.remove('pop');
  void btn.offsetWidth;
  btn.classList.add('pop');
  setTimeout(() => btn.classList.remove('pop'), 450);
}

function updateFavBtn() {
  if (!App.currentQuote) return;
  const qid = quoteId(App.currentQuote);
  const isFav = App.favorites.some(f => quoteId(f) === qid);
  const btn = document.getElementById('btn-fav');
  btn.classList.toggle('active', isFav);
  const icon = btn.querySelector('.fav-icon');
  if (icon) icon.textContent = isFav ? 'â™¥ï¸' : 'ğŸ“Œ';
  // Bouton header : affiche â™¥ï¸ si au moins 1 favori + compteur
  const btnHeader = document.getElementById('btn-fav-header');
  if (btnHeader) {
    const hIcon = btnHeader.querySelector('.btn-fav-header-icon');
    if (hIcon) hIcon.textContent = App.favorites.length > 0 ? 'â™¥ï¸' : 'ğŸ¤';
  }
  updateFavCount();
}

function updateFavCount() {
  const badge = document.getElementById('fav-count-badge');
  if (badge) badge.textContent = App.favorites.length > 0 ? ' (' + App.favorites.length + ')' : '';
}

function openHistorySheet() {
  const list = document.getElementById('fav-list');
  list.innerHTML = '';
  if (!App.favorites.length) {
    list.innerHTML = '<p style="color:var(--ink-light);font-size:14px;text-align:center;padding:20px">Aucun favori pour l\'instant</p>';
  } else {
    App.favorites.forEach(q => {
      const item = document.createElement('div');
      item.className = 'sheet-item';
      item.textContent = getCol(q, COL.quote);
      item.onclick = () => { displayQuote(q); navigate('quote'); closeHistorySheetSmooth(); };
      list.appendChild(item);
    });
  }
  document.getElementById('history-sheet').classList.add('open');
}

function closeHistorySheetSmooth() {
  const overlay = document.getElementById('history-sheet');
  const sheet = overlay.querySelector('.sheet');
  sheet.style.transform = '';
  overlay.classList.remove('open');
}

function closeHistorySheet(e) {
  if (!e || e.target === document.getElementById('history-sheet')) {
    closeHistorySheetSmooth();
  }
}

// â”€â”€ Swipe-down to dismiss App.favorites sheet â”€â”€
(function initFavSheetDrag() {
  let startY = 0, currentY = 0, dragging = false;
  const getSheet = () => document.querySelector('#history-sheet .sheet');
  const getOverlay = () => document.getElementById('history-sheet');

  function onStart(e) {
    const overlay = getOverlay();
    if (!overlay.classList.contains('open')) return;
    const sheet = getSheet();
    const rect = sheet.getBoundingClientRect();
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    if (clientY < rect.top || clientY > rect.top + 48) return;
    dragging = true;
    startY = clientY;
    currentY = clientY;
    sheet.style.transition = 'none';
  }

  function onMove(e) {
    if (!dragging) return;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    currentY = clientY;
    const dy = Math.max(0, currentY - startY);
    getSheet().style.transform = `translateY(${dy}px)`;
    const overlay = getOverlay();
    const progress = Math.min(dy / 300, 1);
    overlay.style.background = `rgba(0,0,0,${0.18 * (1 - progress)})`;
    if (e.cancelable) e.preventDefault();
  }

  function onEnd() {
    if (!dragging) return;
    dragging = false;
    const dy = currentY - startY;
    const sheet = getSheet();
    const overlay = getOverlay();
    sheet.style.transition = '';
    overlay.style.background = '';
    if (dy > 100) {
      closeHistorySheetSmooth();
    } else {
      sheet.style.transform = '';
    }
  }

  document.addEventListener('touchstart', onStart, { passive: true });
  document.addEventListener('touchmove', onMove, { passive: false });
  document.addEventListener('touchend', onEnd);
  document.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistory() {
  const list = document.getElementById('history-list');
  const empty = document.getElementById('history-empty');

  if (!App.sessionHistory.length) {
    list.innerHTML = '';
    empty.style.display = 'flex';
    return;
  }
  empty.style.display = 'none';

  function timeAgo(ts) {
    if (!ts) return '';
    const diff = Math.floor((Date.now() - ts) / 1000);
    if (diff < 60) return 'Ã  l\'instant';
    if (diff < 3600) return Math.floor(diff / 60) + ' min';
    if (diff < 86400) return Math.floor(diff / 3600) + ' h';
    return Math.floor(diff / 86400) + ' j';
  }

  const html = App.sessionHistory.map((entry, idx) => {
    const q = entry.q;
    const quoteKey = getCol(q, COL.quote);
    const isFav = App.favorites.some(f => quoteId(f) === quoteId(q));
    const name  = getCol(q, COL.name) || '?';
    const loc   = getCol(q, COL.location) || '';
    const cat   = getCol(q, COL.mainCat) || '';
    const catHtml = cat ? ' <span class="history-cat-badge">' + esc(cat) + '</span>' : '';
    const timeStr = timeAgo(entry.ts);
    const timeHtml = timeStr ? '<span class="history-time">' + timeStr + '</span>' : '';

    return '<div class="history-swipe" data-idx="' + idx + '">' +
      '<div class="history-swipe-bg bg-fav">â™¥ï¸ Favori</div>' +
      '<div class="history-swipe-bg bg-del">Supprimer ğŸ—‘</div>' +
      '<div class="history-item' + (isFav ? ' is-fav' : '') + '" data-rank="' + idx + '">' +
        '<div class="history-item-body">' +
          '<div class="history-quote">' + esc(quoteKey) + '</div>' +
          '<div class="history-meta">' +
            '<div class="history-author"><span class="history-author-arrow">></span>' + esc(name) + ' Â· ' + esc(loc) + catHtml + '</div>' +
            timeHtml +
          '</div>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');

  list.innerHTML = html;

  // Tap to view quote
  list.onclick = (e) => {
    const wrapper = e.target.closest('[data-idx]');
    if (!wrapper) return;
    const idx = parseInt(wrapper.dataset.idx);
    const entry = App.sessionHistory[idx];
    if (!entry) return;
    displayQuote(entry.q);
    navigate('quote');
  };

  // Swipe handling
  initHistorySwipe();
}

function initHistorySwipe() {
  const list = document.getElementById('history-list');
  let startX = 0, startY = 0, currentItem = null, swiping = false;

  list.addEventListener('touchstart', (e) => {
    const wrapper = e.target.closest('.history-swipe');
    if (!wrapper) return;
    currentItem = wrapper.querySelector('.history-item');
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    swiping = false;
    currentItem.style.transition = 'none';
  }, { passive: true });

  list.addEventListener('touchmove', (e) => {
    if (!currentItem) return;
    const dx = e.touches[0].clientX - startX;
    const dy = e.touches[0].clientY - startY;
    // Only swipe if mostly horizontal
    if (!swiping && Math.abs(dx) > 10 && Math.abs(dx) > Math.abs(dy) * 1.5) {
      swiping = true;
    }
    if (swiping) {
      currentItem.style.transform = 'translateX(' + dx + 'px)';
      e.preventDefault();
    }
  }, { passive: false });

  list.addEventListener('touchend', (e) => {
    if (!currentItem || !swiping) { currentItem = null; return; }
    const dx = e.changedTouches[0].clientX - startX;
    const wrapper = currentItem.closest('.history-swipe');
    const idx = parseInt(wrapper.dataset.idx);
    const threshold = 80;

    if (dx > threshold) {
      // Swipe right â†’ toggle favorite
      const entry = App.sessionHistory[idx];
      if (entry) {
        const added = setFavorite(entry.q);
        currentItem.classList.toggle('is-fav', added);
        showToast(added ? 'â™¥ï¸ AjoutÃ© aux favoris' : 'ğŸ’” RetirÃ© des favoris');
      }
      currentItem.style.transition = 'transform 0.2s ease';
      currentItem.style.transform = '';
    } else if (dx < -threshold) {
      // Swipe left â†’ remove from history
      currentItem.style.transition = 'transform 0.3s ease';
      currentItem.style.transform = 'translateX(-120%)';
      setTimeout(() => {
        wrapper.classList.add('removing');
        requestAnimationFrame(() => {
          wrapper.classList.add('gone');
          setTimeout(() => {
            App.sessionHistory.splice(idx, 1);
            localStorage.setItem('qapp_history', JSON.stringify(App.sessionHistory));
            renderHistory();
          }, 300);
        });
      }, 200);
    } else {
      // Snap back
      currentItem.style.transition = 'transform 0.2s ease';
      currentItem.style.transform = '';
    }
    currentItem = null;
    swiping = false;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildFilters() {
  const uniq = (key) => [...new Set(App.allQuotes.map(q => getCol(q, key)).filter(Boolean))].sort();

  buildChipFilter('filter-authors', uniq(COL.name), 'authors');
  buildChipFilter('filter-main-cats', uniq(COL.mainCat), 'mainCats');
  buildChipFilter('filter-second-cats', uniq(COL.secondCat), 'secondCats');
  buildChipFilter('filter-locations', uniq(COL.location), 'locations');
  buildChipFilter('filter-alcohol', uniq(COL.alcohol), 'alcohol');
  buildChipFilter('filter-volumes', uniq(COL.volume), 'volumes');
}

function buildChipFilter(containerId, values, filterKey) {
  const container = document.getElementById(containerId);
  const el = container.querySelector('.filter-chips-inner') || container;
  el.innerHTML = '';
  values.forEach(v => {
    const chip = document.createElement('button');
    chip.className = 'chip';
    chip.textContent = v;
    chip.onclick = () => {
      chip.classList.toggle('active');
      const arr = activeFilters[filterKey];
      const idx = arr.indexOf(v);
      if (idx === -1) arr.push(v); else arr.splice(idx, 1);
      applyFilters();
    };
    el.appendChild(chip);
  });
}

function applyFilters() {
  activeFilters.search = document.getElementById('search-input').value.toLowerCase();
  App.filteredQuotes = App.allQuotes.filter(q => {
    if (activeFilters.authors.length && !activeFilters.authors.includes(getCol(q, COL.name))) return false;
    if (activeFilters.mainCats.length && !activeFilters.mainCats.includes(getCol(q, COL.mainCat))) return false;
    if (activeFilters.secondCats.length && !activeFilters.secondCats.includes(getCol(q, COL.secondCat))) return false;
    if (activeFilters.locations.length && !activeFilters.locations.includes(getCol(q, COL.location))) return false;
    if (activeFilters.alcohol.length && !activeFilters.alcohol.includes(getCol(q, COL.alcohol))) return false;
    if (activeFilters.volumes.length && !activeFilters.volumes.includes(getCol(q, COL.volume))) return false;
    if (activeFilters.search) {
      const haystack = (getCol(q, COL.quote) + ' ' + getCol(q, COL.context)).toLowerCase();
      if (!haystack.includes(activeFilters.search)) return false;
    }
    return true;
  });
  buildQueue();
  updateFilterCount();
  updateFilterBtnState();
  refreshFilterCatStates();
  App.statsDirty = true;
}

function resetFilters() {
  activeFilters.authors = [];
  activeFilters.mainCats = [];
  activeFilters.secondCats = [];
  activeFilters.locations = [];
  activeFilters.alcohol = [];
  activeFilters.volumes = [];
  activeFilters.search = '';
  // Vider la recherche
  const si = document.getElementById('search-input');
  if (si) si.value = '';
  // DÃ©sÃ©lectionner tous les chips du panneau filtre overlay
  document.querySelectorAll('.filter-collapsible .chip').forEach(c => c.classList.remove('active'));
  // Retirer l'Ã©tat actif des boutons de catÃ©gorie
  document.querySelectorAll('.filter-cat-toggle').forEach(t => t.classList.remove('has-active'));
  // Remettre toutes les phrases
  App.filteredQuotes = [...App.allQuotes];
  buildQueue();
  updateFilterCount();
  updateFilterBtnState();
  localStorage.removeItem('qapp_filters');
  App.statsDirty = true;
}

// Clear filters from stats banner and rebuild stats
function clearStatsFilter() {
  resetFilters();
  App.statsDirty = true;
  buildStats();
  showToast('Filtres supprimÃ©s');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHART_PALETTE = [
  '#7c6af7','#4ade80','#f472b6','#22d3ee','#fbbf24',
  '#a78bfa','#34d399','#fb7185','#60a5fa','#facc15',
  '#c084fc','#2dd4bf','#f87171','#38bdf8','#a3e635'
];
// Deterministic color for a label â€” same label always gets same color
const _colorCache = {};
function labelColor(label) {
  if (_colorCache[label]) return _colorCache[label];
  let hash = 0;
  for (let i = 0; i < label.length; i++) hash = ((hash << 5) - hash + label.charCodeAt(i)) | 0;
  _colorCache[label] = CHART_PALETTE[Math.abs(hash) % CHART_PALETTE.length];
  return _colorCache[label];
}

function destroyChart(id) {
  if (App.charts[id]) { App.charts[id].destroy(); delete App.charts[id]; }
}

// Filter out n/a, empty, null, "?", "no data" etc. from stats
function isValid(val) {
  if (!val) return false;
  const v = String(val).trim().toLowerCase();
  return v !== '' && v !== 'n/a' && v !== 'na' && v !== '?' && !/^no data/i.test(v);
}

// chartJsLoaded is in App.chartJsLoaded
async function loadChartJS() {
  if (App.chartJsLoaded) return;
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
    s.onload = () => { App.chartJsLoaded = true; resolve(); };
    s.onerror = () => reject(new Error('Chart.js failed to load'));
    document.head.appendChild(s);
  });
}

async function buildStats() {
  if (!App.allQuotes.length) return;
  if (!App.statsDirty) return; // skip if nothing changed

  const statsEl = document.getElementById('screen-stats');
  statsEl.style.opacity = '0';

  // Lazy-load Chart.js on first Stats visit
  if (!App.chartJsLoaded) {
    try {
      await loadChartJS();
    } catch (e) {
      console.warn(e);
      showToast('Impossible de charger les graphiques');
      statsEl.style.opacity = '';
      return;
    }
  }

  // Use filteredQuotes â€” show/hide top+bottom banners
  const data = App.filteredQuotes;
  const isFiltered = data.length !== App.allQuotes.length;
  const bannerBottom = document.getElementById('stats-banner-bottom');
  if (isFiltered) {
    bannerBottom.classList.add('show');
  } else {
    bannerBottom.classList.remove('show');
  }

  // Empty state helpers
  function showEmpty(cardId, msg) {
    const card = document.getElementById(cardId);
    if (!card) return;
    const canvas = card.querySelector('canvas');
    const empty = card.querySelector('.chart-empty');
    if (canvas) canvas.style.display = 'none';
    if (empty) { empty.textContent = msg; empty.style.display = ''; }
  }
  function clearEmpty(cardId) {
    const card = document.getElementById(cardId);
    if (!card) return;
    const canvas = card.querySelector('canvas');
    const empty = card.querySelector('.chart-empty');
    if (canvas) canvas.style.display = '';
    if (empty) empty.style.display = 'none';
  }

  // â”€â”€ OVERVIEW â”€â”€
  const uniqAuthors = new Set(data.map(q=>getCol(q,COL.name)).filter(isValid)).size;
  const locFreqOverview = {};
  data.forEach(q => { const l = getCol(q,COL.location); if (isValid(l)) locFreqOverview[l]=(locFreqOverview[l]||0)+1; });
  const topLocSorted = Object.entries(locFreqOverview).sort((a,b)=>b[1]-a[1]);
  const topLocName = topLocSorted.length >= 2 ? topLocSorted[1][0] : (topLocSorted[0] ? topLocSorted[0][0] : 'â€”');
  const catFreq = {};
  data.forEach(q => { const c = getCol(q,COL.mainCat); if (isValid(c)) catFreq[c]=(catFreq[c]||0)+1; });
  const overviewCatSorted = Object.entries(catFreq).sort((a,b)=>b[1]-a[1]);
  const topCatName = overviewCatSorted.length >= 2 ? overviewCatSorted[1][0] : (overviewCatSorted[0] ? overviewCatSorted[0][0] : 'â€”');

  document.getElementById('stat-overview').innerHTML =
    '<div class="stat-mini hero"><div class="num">' + data.length + '</div><div class="lbl">Phrases au total</div></div>' +
    '<div class="stat-mini"><div class="num" style="color:#4ade80;font-size:18px">' + uniqAuthors + '</div><div class="lbl">Auteurs</div></div>' +
    '<div class="stat-mini"><div class="num" style="color:#fbbf24;font-size:14px">' + esc(topLocName) + '</div><div class="lbl">Top lieu</div></div>' +
    '<div class="stat-mini"><div class="num" style="color:#f472b6;font-size:14px">' + esc(topCatName) + '</div><div class="lbl">CatÃ©gorie #1</div></div>';

  // â”€â”€ PHRASE DU JOUR â”€â”€
  // Find quotes said on the same day-of-year (month+day) as today
  const today = new Date();
  const todayMonth = today.getMonth();
  const todayDate = today.getDate();
  const dailyQuotes = data.filter(q => {
    const d = parseDate(getCol(q, COL.ts));
    return d && d.getMonth() === todayMonth && d.getDate() === todayDate;
  });

  const dailyEl = document.getElementById('stat-daily');
  if (dailyQuotes.length) {
    // Pick one deterministically (based on day-of-year so it's stable all day)
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
    const pick = dailyQuotes[dayOfYear % dailyQuotes.length];
    const qText = getCol(pick, COL.quote) || '';
    const qName = getCol(pick, COL.name) || '?';
    const qDate = getCol(pick, COL.ts) || '';
    const parsedDate = parseDate(qDate);
    const year = parsedDate ? parsedDate.getFullYear() : '';

    dailyEl.innerHTML =
      '<div class="stat-daily-item" id="stat-daily-item">' +
        '<div class="stat-daily-quote">' + esc(qText) + '</div>' +
        '<div class="stat-daily-author">' + esc(qName) + (year ? ' <span>Â· ' + year + '</span>' : '') + '</div>' +
      '</div>';

    document.getElementById('stat-daily-item').onclick = () => {
      displayQuote(pick);
      navigate('quote');
    };
  } else {
    dailyEl.innerHTML = '<div class="stat-daily-empty">' +
      '<span>Aucune phrase un ' + todayDate + '/' + String(todayMonth + 1).padStart(2, '0') + '</span>' +
      '<a href="sms:?body=ğŸ’¬ Nouvelle phrase pour our quotes !" class="daily-send-btn" style="text-decoration:none">J\'envoie une phrase ğŸ’¬</a>' +
    '</div>';
  }

  // â”€â”€ PERSONS â€” top 10 â”€â”€
  const personCounts = {};
  data.forEach(q => { const n = getCol(q,COL.name); if (isValid(n)) personCounts[n] = (personCounts[n]||0)+1; });
  const personSorted = Object.entries(personCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
  destroyChart('persons');
  if (personSorted.length) {
    clearEmpty('card-persons');
    App.charts.persons = new Chart(document.getElementById('chart-persons'), {
      type: 'bar',
      data: { labels: personSorted.map(e=>e[0]), datasets:[{ data: personSorted.map(e=>e[1]), backgroundColor: personSorted.map(e=>labelColor(e[0])), borderRadius:8, borderSkipped:false }]},
      options: chartOpts('Phrases')
    });
    chartClickFilter(App.charts.persons, 'authors', personSorted.map(e=>e[0]));
  } else { showEmpty('card-persons', 'Aucun auteur trouvÃ©'); }

  // â”€â”€ CATEGORIES â€” donut â”€â”€
  const catCounts = {};
  data.forEach(q => { const c = getCol(q,COL.mainCat); if (isValid(c)) catCounts[c]=(catCounts[c]||0)+1; });
  const catSorted = Object.entries(catCounts).sort((a,b)=>b[1]-a[1]);
  const catTotal = catSorted.reduce((s,e)=>s+e[1],0);
  destroyChart('cats');
  if (catSorted.length) {
    clearEmpty('card-cats');
    const doughnutPctPlugin = {
      id: 'doughnutPct',
      afterDatasetsDraw(chart) {
        const { ctx, data } = chart;
        const total = data.datasets[0].data.reduce((s,v)=>s+v,0);
        ctx.save();
        data.datasets[0].data.forEach((val, i) => {
          const meta = chart.getDatasetMeta(0);
          const arc  = meta.data[i];
          if (!arc) return;
          const pct = Math.round(val / total * 100);
          if (pct < 4) return;
          const angle = (arc.startAngle + arc.endAngle) / 2;
          const r = (arc.innerRadius + arc.outerRadius) / 2;
          const x = arc.x + Math.cos(angle) * r;
          const y = arc.y + Math.sin(angle) * r;
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 10px JetBrains Mono, monospace';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(pct + '%', x, y);
        });
        ctx.restore();
      }
    };
    App.charts.cats = new Chart(document.getElementById('chart-cats'), {
      type: 'doughnut',
      data: { labels: catSorted.map(e=>e[0]), datasets:[{ data: catSorted.map(e=>e[1]), backgroundColor: catSorted.map(e=>labelColor(e[0])), borderWidth:0, borderColor:'transparent', hoverOffset:18, hoverBorderWidth:2, hoverBorderColor:'#fff' }]},
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { top: 10, bottom: 0 } },
        plugins: {
          legend: {
            position:'bottom',
            labels:{ font:{family:'JetBrains Mono',size:10}, color:'#8b8fac', boxWidth:10, padding:12, usePointStyle:true },
            padding: 24
          },
          tooltip: { callbacks: { label: function(ctx) {
            const pct = Math.round(ctx.raw / catTotal * 100);
            return ' ' + ctx.label + ': ' + ctx.raw + ' (' + pct + '%)';
          }}}
        }
      },
      plugins: [doughnutPctPlugin]
    });
    chartClickFilter(App.charts.cats, 'mainCats', catSorted.map(e=>e[0]));
  } else { showEmpty('card-cats', 'Aucune catÃ©gorie trouvÃ©e'); }

  // â”€â”€ HOURS â”€â”€
  const hourCounts = Array(24).fill(0);
  data.forEach(q => { const d = parseDate(getCol(q,COL.ts)); if(d) hourCounts[d.getHours()]++; });
  destroyChart('hours');
  if (hourCounts.some(v => v > 0)) {
    clearEmpty('card-hours');
    App.charts.hours = new Chart(document.getElementById('chart-hours'), {
      type: 'line',
      data: { labels: Array.from({length:24},(_,i)=>`${i}h`), datasets:[{ data:hourCounts, borderColor:'#5b4ff5', backgroundColor:'rgba(91,79,245,0.1)', fill:true, tension:0.4, pointRadius:3, pointBackgroundColor:'#5b4ff5' }]},
      options: chartOpts('Phrases')
    });
  } else { showEmpty('card-hours', 'Aucun horodateur disponible'); }

  // â”€â”€ LOCATIONS (hors Paris) â”€â”€
  const locCounts = {};
  data.forEach(q => {
    const l = getCol(q,COL.location);
    if (isValid(l)) locCounts[l]=(locCounts[l]||0)+1;
  });
  const locSorted = Object.entries(locCounts).sort((a,b)=>b[1]-a[1]).slice(1,8);
  destroyChart('locations');
  if (locSorted.length) {
    clearEmpty('card-locations');
    App.charts.locations = new Chart(document.getElementById('chart-locations'), {
      type: 'bar',
      data: { labels: locSorted.map(e=>e[0]), datasets:[{ data: locSorted.map(e=>e[1]), backgroundColor: locSorted.map(e=>labelColor(e[0])), borderRadius:8, borderSkipped:false }]},
      options: { ...chartOpts('Phrases'), indexAxis:'y' }
    });
    chartClickFilter(App.charts.locations, 'locations', locSorted.map(e=>e[0]));
  } else { showEmpty('card-locations', 'Aucun lieu trouvÃ©'); }

  // â”€â”€ VOLUMES â”€â”€
  const volCounts = {};
  data.forEach(q => { const v = getCol(q,COL.volume); if (isValid(v)) volCounts[v]=(volCounts[v]||0)+1; });
  destroyChart('volumes');
  if (Object.keys(volCounts).length) {
    clearEmpty('card-volumes');
    const volSorted = Object.entries(volCounts).sort((a,b)=>{
      const na = parseInt(a[0])||0, nb = parseInt(b[0])||0;
      return na - nb || a[0].localeCompare(b[0]);
    });
    App.charts.volumes = new Chart(document.getElementById('chart-volumes'), {
      type: 'bar',
      data: { labels: volSorted.map(e=>e[0]), datasets:[{ data:volSorted.map(e=>e[1]), backgroundColor: volSorted.map(e=>labelColor(e[0])), borderRadius:8, borderSkipped:false }]},
      options: chartOpts('Phrases')
    });
    chartClickFilter(App.charts.volumes, 'volumes', volSorted.map(e=>e[0]));
  } else { showEmpty('card-volumes', 'Aucun volume trouvÃ©'); }

  App.statsDirty = false;
  // Fade in after build
  requestAnimationFrame(() => {
    statsEl.style.transition = 'opacity 0.3s ease';
    statsEl.style.opacity = '';
    setTimeout(() => { statsEl.style.transition = ''; }, 350);
  });

}

function chartOpts(yLabel) {
  return {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: { display: false },
      tooltip: { callbacks: { label: ctx => ` ${ctx.raw} phrase${ctx.raw > 1 ? 's' : ''}` } }
    },
    scales: {
      x: { grid: { color:'rgba(255,255,255,0.04)' }, ticks: { font:{family:'JetBrains Mono',size:10}, color:'#6b70a0' } },
      y: { grid: { color:'rgba(255,255,255,0.04)' }, ticks: { font:{family:'JetBrains Mono',size:10}, color:'#6b70a0' } }
    }
  };
}

// Click on a chart element â†’ filter quotes by that label, navigate to quotes
function chartClickFilter(chart, filterKey, labels) {
  chart.canvas.style.cursor = 'pointer';
  chart.canvas.onclick = (evt) => {
    const points = chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
    if (!points.length) return;
    const idx = points[0].index;
    const label = labels[idx];
    if (!label) return;
    // Reset all filters then set just the clicked one
    resetFilters();
    activeFilters[filterKey] = [label];
    applyFilters();
    // Activate the corresponding chip visually
    const chipContainer = {
      authors: 'filter-authors',
      mainCats: 'filter-main-cats',
      secondCats: 'filter-second-cats',
      locations: 'filter-locations',
      alcohol: 'filter-alcohol',
      volumes: 'filter-volumes'
    }[filterKey];
    if (chipContainer) {
      const chips = document.querySelectorAll('#' + chipContainer + ' .chip');
      chips.forEach(c => { if (c.textContent === label) c.classList.add('active'); });
    }
    // Stay on stats â€” rebuild with filtered data
    App.statsDirty = true;
    buildStats();
    // Scroll to top of stats
    document.getElementById('screen-stats').scrollTo({ top: 0, behavior: 'smooth' });
    showToast('Filtre : ' + label);
  };
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTER MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openFilterMenu() {
  const overlay = document.getElementById('filter-overlay');
  const btn = document.getElementById('btn-filter-toggle');
  overlay.classList.add('open');
  btn.classList.add('active');
  updateFilterCount();
}

function closeFilterMenuSmooth() {
  const overlay = document.getElementById('filter-overlay');
  const btn = document.getElementById('btn-filter-toggle');
  const menu = overlay.querySelector('.filter-menu');
  // Reset any drag transform â€” let CSS transition handle close
  menu.style.transform = '';
  overlay.classList.remove('open');
  btn.classList.remove('active');
}

function toggleFilterMenu() {
  const overlay = document.getElementById('filter-overlay');
  overlay.classList.contains('open') ? closeFilterMenuSmooth() : openFilterMenu();
}

// Long press (2s) on filter button â†’ reset filters
(function initFilterLongPress() {
  let pressTimer = null;
  let didLongPress = false;
  const btn = document.getElementById('btn-filter-toggle');
  if (!btn) return;

  function startPress() {
    didLongPress = false;
    pressTimer = setTimeout(() => {
      didLongPress = true;
      const hasFilters = activeFilters.authors.length || activeFilters.mainCats.length ||
        activeFilters.secondCats.length || activeFilters.locations.length ||
        activeFilters.alcohol.length || activeFilters.volumes.length || activeFilters.search;
      if (hasFilters) {
        resetFilters();
        showToast('Filtres supprimÃ©s');
      }
    }, 2000);
  }
  function endPress() {
    clearTimeout(pressTimer);
    if (!didLongPress) toggleFilterMenu();
  }
  function cancelPress() { clearTimeout(pressTimer); }

  btn.addEventListener('mousedown', startPress);
  btn.addEventListener('mouseup', endPress);
  btn.addEventListener('mouseleave', cancelPress);
  btn.addEventListener('touchstart', startPress, { passive: true });
  btn.addEventListener('touchend', (e) => { e.preventDefault(); endPress(); });
  btn.addEventListener('touchcancel', cancelPress);
})();

function closeFilterMenu(e) {
  if (e.target === document.getElementById('filter-overlay')) {
    closeFilterMenuSmooth();
  }
}

// â”€â”€ Swipe-down to dismiss filter panel â”€â”€
(function initFilterDrag() {
  let startY = 0, currentY = 0, dragging = false;
  const getMenu = () => document.querySelector('.filter-menu');
  const getOverlay = () => document.getElementById('filter-overlay');

  function onStart(e) {
    const overlay = getOverlay();
    if (!overlay.classList.contains('open')) return;
    const menu = getMenu();
    // Only start drag if touch is on the handle area (top 48px of panel)
    const rect = menu.getBoundingClientRect();
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    if (clientY < rect.top || clientY > rect.top + 48) return;
    dragging = true;
    startY = clientY;
    currentY = clientY;
    menu.style.transition = 'none';
  }

  function onMove(e) {
    if (!dragging) return;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    currentY = clientY;
    const dy = Math.max(0, currentY - startY);
    const menu = getMenu();
    menu.style.transform = `translateY(${dy}px)`;
    // Fade backdrop proportionally
    const overlay = getOverlay();
    const progress = Math.min(dy / 300, 1);
    overlay.style.background = `rgba(0,0,0,${0.18 * (1 - progress)})`;
    if (e.cancelable) e.preventDefault();
  }

  function onEnd() {
    if (!dragging) return;
    dragging = false;
    const dy = currentY - startY;
    const menu = getMenu();
    const overlay = getOverlay();
    menu.style.transition = '';
    overlay.style.background = '';
    if (dy > 100) {
      closeFilterMenuSmooth();
    } else {
      menu.style.transform = '';
    }
  }

  document.addEventListener('touchstart', onStart, { passive: true });
  document.addEventListener('touchmove', onMove, { passive: false });
  document.addEventListener('touchend', onEnd);
  document.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
})();

function updateFilterCount() {
  const el = document.getElementById('filter-count');
  if (!el) return;
  const n = activeFilters.authors.length + activeFilters.mainCats.length +
    activeFilters.secondCats.length + activeFilters.locations.length +
    activeFilters.alcohol.length + activeFilters.volumes.length + (activeFilters.search ? 1 : 0);
  el.textContent = n === 0 ? 'Aucun filtre actif' : `${n} filtre${n > 1 ? 's' : ''} actif${n > 1 ? 's' : ''}`;
}

function toggleFilterCat(id) {
  const chips  = document.getElementById('filter-' + id);
  const toggle = chips ? chips.previousElementSibling : null;
  if (!chips || !toggle) return;
  const isOpen = chips.classList.toggle('open');
  toggle.classList.toggle('open', isOpen);
  // Reflet actif
  updateFilterCatState(id, toggle);
}

function updateFilterCatState(id, toggle) {
  if (!toggle) return;
  const keyMap = {
    'authors': 'authors', 'main-cats': 'mainCats',
    'second-cats': 'secondCats', 'locations': 'locations', 'alcohol': 'alcohol', 'volumes': 'volumes'
  };
  const key = keyMap[id];
  const hasActive = key && activeFilters[key] && activeFilters[key].length > 0;
  toggle.classList.toggle('has-active', hasActive);
}

function refreshFilterCatStates() {
  ['authors','main-cats','second-cats','locations','alcohol','volumes'].forEach(id => {
    const chips  = document.getElementById('filter-' + id);
    const toggle = chips ? chips.previousElementSibling : null;
    updateFilterCatState(id, toggle);
  });
}


function loadSavedFilters() {
  const saved = localStorage.getItem('qapp_filters');
  if (!saved) return;
  try {
    activeFilters = JSON.parse(saved);
    if (activeFilters.search) {
      const si = document.getElementById('search-input');
      if (si) si.value = activeFilters.search;
    }
    applyFilters();
    // Re-highlight chips
    setTimeout(() => {
      syncFilterChips();
      updateFilterBtnState();
    }, 50);
  } catch(e) {}
}

function syncFilterChips() {
  document.querySelectorAll('#filter-authors .chip').forEach(c => {
    c.classList.toggle('active', activeFilters.authors.includes(c.textContent));
  });
  document.querySelectorAll('#filter-main-cats .chip').forEach(c => {
    c.classList.toggle('active', activeFilters.mainCats.includes(c.textContent));
  });
  document.querySelectorAll('#filter-second-cats .chip').forEach(c => {
    c.classList.toggle('active', activeFilters.secondCats.includes(c.textContent));
  });
  document.querySelectorAll('#filter-locations .chip').forEach(c => {
    c.classList.toggle('active', activeFilters.locations.includes(c.textContent));
  });
  document.querySelectorAll('#filter-alcohol .chip').forEach(c => {
    c.classList.toggle('active', activeFilters.alcohol.includes(c.textContent));
  });
  document.querySelectorAll('#filter-volumes .chip').forEach(c => {
    c.classList.toggle('active', activeFilters.volumes.includes(c.textContent));
  });
}

function updateFilterBtnState() {
  const n = activeFilters.authors.length + activeFilters.mainCats.length +
    activeFilters.secondCats.length + activeFilters.locations.length +
    activeFilters.alcohol.length + activeFilters.volumes.length + (activeFilters.search ? 1 : 0);
  const btn = document.getElementById('btn-filter-toggle');
  if (btn) {
    btn.classList.toggle('active', n > 0);
    const lbl = btn.querySelector('.filter-label');
    if (lbl) lbl.textContent = n > 0 ? n + ' Filtre' + (n > 1 ? 's' : '') : 'Filtrer';
  }
  const rst = document.querySelector('.filter-reset');
  if (rst) rst.classList.toggle('has-filters', n > 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// App.toastTimer is in App.toastTimer
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(App.toastTimer);
  App.toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

function dismissInstallBanner() {
  document.getElementById('pwa-install-overlay').classList.remove('show');
  // If checkbox checked, remember permanently
  if (document.getElementById('pwa-noremind').checked) {
    localStorage.setItem('qapp_install_never', '1');
  }
  localStorage.setItem('qapp_install_dismissed', '1');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  // Nav masquÃ©e pendant le chargement
  document.getElementById('bottom-nav').style.display = 'none';
  document.getElementById('no-data-screen').classList.add('active');

  // Charge data.json depuis GitHub Pages
  fetchData();

  // â”€â”€ PWA: Service Worker + Update Detection â”€â”€
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(reg => {
      // Check for updates every 60s
      setInterval(() => reg.update(), 60000);

      // Detect new SW waiting â†’ show update banner
      function showUpdateBanner() {
        document.getElementById('pwa-update-banner').classList.add('show');
        // On click, tell waiting SW to activate
        document.getElementById('pwa-update-banner').onclick = () => {
          if (reg.waiting) reg.waiting.postMessage('skipWaiting');
        };
      }
      if (reg.waiting) showUpdateBanner();
      reg.addEventListener('updatefound', () => {
        const newSW = reg.installing;
        if (!newSW) return;
        newSW.addEventListener('statechange', () => {
          if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
            showUpdateBanner();
          }
        });
      });
      // Auto-reload when new SW takes over
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) { refreshing = true; location.reload(); }
      });
    }).catch(() => {});
  }

  // â”€â”€ PWA: Install Prompt â”€â”€
  (function initInstallBanner() {
    // Already installed as PWA â†’ skip
    if (window.matchMedia('(display-mode: standalone)').matches) return;
    if (window.navigator.standalone === true) return; // iOS

    // User checked "ne plus me le rappeler" â†’ never show again
    if (localStorage.getItem('qapp_install_never')) return;

    // Already dismissed this session â†’ still show next time (unless _never)
    if (localStorage.getItem('qapp_install_dismissed')) return;

    // Show after 5 seconds
    setTimeout(() => {
      document.getElementById('pwa-install-overlay').classList.add('show');
    }, 5000);
  })();

  // Raccourci clavier : espace / entrÃ©e â†’ phrase suivante
  document.addEventListener('keydown', e => {
    if (e.key === ' ' || e.key === 'Enter') showRandom();
  });

  // Swipe gauche/droite sur l'Ã©cran quote â†’ phrase suivante
  (function initQuoteSwipe() {
    let startX = 0, startY = 0;
    const quoteScreen = document.getElementById('screen-quote');

    quoteScreen.addEventListener('touchstart', e => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    }, { passive: true });

    quoteScreen.addEventListener('touchend', e => {
      const dx = e.changedTouches[0].clientX - startX;
      const dy = e.changedTouches[0].clientY - startY;
      // Only trigger on horizontal swipes (dx > 80px, and more horizontal than vertical)
      if (Math.abs(dx) > 80 && Math.abs(dx) > Math.abs(dy) * 1.5) {
        showRandom();
      }
    });
  })();
});
</script>
<script>
  document.addEventListener('selectstart', e => e.preventDefault());
  document.addEventListener('contextmenu', e => e.preventDefault());
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0d0f1a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="QuoteApp" />
  <title>QuoteApp</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* ‚îÄ‚îÄ DESIGN TOKENS ‚îÄ‚îÄ */
    :root {
      --bg:          #0d0f1a;
      --bg2:         #111320;
      --panel:       #141728;
      --card:        #1a1e30;
      --border:      #252a42;
      --border-glow: #7c6af744;

      --accent:      #7c6af7;
      --accent-dim:  #7c6af733;
      --accent-glow: 0 0 20px #7c6af755, 0 0 60px #7c6af722;
      --green:       #4ade80;
      --amber:       #fbbf24;
      --pink:        #f472b6;
      --cyan:        #22d3ee;

      --text:        #e2e0f0;
      --text-mid:    #8b8fac;
      --text-dim:    #4a4f6a;

      --font-mono:   'JetBrains Mono', 'Courier New', monospace;
      --font-body:   'DM Sans', system-ui, sans-serif;

      --radius:      14px;
      --radius-sm:   8px;
      --safe-top:    env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      font-family: var(--font-mono);
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
    }

    /* Scanline texture overlay */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.03) 2px,
        rgba(0,0,0,0.03) 4px
      );
      pointer-events: none;
      z-index: 1000;
    }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .app {
      display: flex;
      flex-direction: column;
      height: 100dvh;
      max-width: 480px;
      margin: 0 auto;
      background: var(--bg);
      position: relative;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: calc(var(--safe-top) + 14px) 18px 14px;
      background: rgba(13,15,26,0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      position: relative;
      z-index: 10;
      flex-shrink: 0;
    }

    .app-name {
      font-family: var(--font-mono);
      font-size: 13px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .app-name::before {
      content: '// ';
      color: var(--text-dim);
      font-weight: 300;
    }

    .header-actions { display: flex; gap: 6px; }

    .icon-btn {
      width: 34px; height: 34px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text-mid);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      transition: border-color 0.15s, color 0.15s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
      font-family: var(--font-mono);
    }
    .icon-btn:active { transform: scale(0.9); border-color: var(--accent); color: var(--accent); }

    /* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
    .screen {
      display: none;
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .screen.active { display: flex; flex-direction: column; }

    /* ‚îÄ‚îÄ QUOTE SCREEN ‚îÄ‚îÄ */
    #screen-quote {
      padding: 0;
      justify-content: space-between;
    }

    .quote-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 28px 22px 16px;
      min-height: 0;
      position: relative;
    }

    /* Corner brackets decoration */
    .quote-area::before, .quote-area::after {
      content: '';
      position: absolute;
      width: 20px; height: 20px;
      border-color: var(--border-glow);
      border-style: solid;
    }
    .quote-area::before {
      top: 16px; left: 16px;
      border-width: 2px 0 0 2px;
    }
    .quote-area::after {
      bottom: 16px; right: 16px;
      border-width: 0 2px 2px 0;
    }

    .quote-line-num {
      font-size: 10px;
      color: var(--text-dim);
      letter-spacing: 1px;
      margin-bottom: 16px;
      font-family: var(--font-mono);
    }

    .quote-mark {
      font-family: var(--font-mono);
      font-size: 48px;
      line-height: 0.7;
      color: var(--accent-dim);
      margin-bottom: 14px;
      display: block;
      font-weight: 700;
    }

    .quote-text {
      font-family: var(--font-mono);
      font-size: clamp(15px, 4.5vw, 20px);
      line-height: 1.7;
      color: var(--text);
      font-weight: 300;
      font-style: italic;
      transition: opacity 0.25s ease;
      /* Cursor blink at end */
      position: relative;
    }

    .quote-text.loading { opacity: 0.15; }

    .cursor-blink {
      display: inline-block;
      width: 2px;
      height: 1.1em;
      background: var(--accent);
      margin-left: 3px;
      vertical-align: text-bottom;
      animation: blink 1s step-end infinite;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

    .quote-meta {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .meta-author {
      font-size: 12px;
      font-weight: 500;
      color: var(--accent);
      font-family: var(--font-mono);
      letter-spacing: 0.5px;
    }
    .meta-author::before { content: '> '; color: var(--green); }

    .meta-secondary {
      font-size: 11px;
      color: var(--text-dim);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      font-family: var(--font-mono);
    }

    .meta-secondary span { display: flex; align-items: center; gap: 4px; }
    .meta-secondary span::before { content: '‚Äî'; color: var(--text-dim); opacity: 0.4; }

    /* ‚îÄ‚îÄ CHIPS AREA ‚îÄ‚îÄ */
    .chips-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      padding: 10px 22px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--card);
      font-size: 11px;
      font-weight: 400;
      font-family: var(--font-mono);
      color: var(--text-mid);
      cursor: pointer;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      letter-spacing: 0.3px;
    }
    .chip::before { content: '['; color: var(--text-dim); }
    .chip::after  { content: ']'; color: var(--text-dim); }
    .chip.active {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }
    .chip.active::before, .chip.active::after { color: var(--accent); }

    /* ‚îÄ‚îÄ DETAILS PANEL ‚îÄ‚îÄ */
    .details-panel {
      display: none;
      flex-direction: column;
      gap: 8px;
      padding: 0 22px 14px;
      animation: fadeIn 0.2s ease;
    }
    .details-panel.open { display: flex; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .detail-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 12px;
      font-family: var(--font-mono);
      line-height: 1.5;
    }
    .detail-label {
      color: var(--green);
      flex-shrink: 0;
      font-size: 11px;
    }
    .detail-label::after { content: ':'; }
    .detail-value { color: var(--text-mid); }

    .alcohol-badge {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .alcohol-badge.yes { background: #fbbf2422; color: var(--amber); border: 1px solid #fbbf2444; }
    .alcohol-badge.no  { background: #4ade8022; color: var(--green);  border: 1px solid #4ade8044; }

    /* ‚îÄ‚îÄ BOTTOM ACTION BAR ‚îÄ‚îÄ */
    .bottom-bar {
      padding: 12px 16px calc(var(--safe-bottom) + 12px);
      display: flex;
      gap: 10px;
      align-items: center;
      border-top: 1px solid var(--border);
      background: rgba(13,15,26,0.95);
      backdrop-filter: blur(12px);
      flex-shrink: 0;
    }

    .btn-random {
      flex: 1;
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--accent);
      background: var(--accent-dim);
      color: var(--accent);
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.15s;
      box-shadow: var(--accent-glow);
      -webkit-tap-highlight-color: transparent;
    }
    .btn-random::before { content: '$ '; opacity: 0.5; }
    .btn-random:active {
      transform: scale(0.98);
      background: var(--accent);
      color: var(--bg);
    }

    .btn-fav {
      width: 48px; height: 48px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--card);
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      flex-shrink: 0;
    }
    .btn-fav:active { transform: scale(0.9); }
    .btn-fav.active { border-color: #f472b644; background: #f472b611; }

    /* ‚îÄ‚îÄ FILTER SCREEN ‚îÄ‚îÄ */
    #screen-filter { padding: 18px; gap: 18px; }

    .filter-section { display: flex; flex-direction: column; gap: 8px; }

    .filter-title {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
      font-family: var(--font-mono);
    }
    .filter-title::before { content: '// '; color: var(--border); }

    .filter-chips { display: flex; flex-wrap: wrap; gap: 6px; }

    .filter-input {
      width: 100%;
      padding: 11px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text);
      background: var(--card);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      caret-color: var(--accent);
    }
    .filter-input::placeholder { color: var(--text-dim); }
    .filter-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }

    .filter-reset {
      padding: 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 1px;
      cursor: pointer;
      text-align: center;
      transition: border-color 0.15s, color 0.15s;
    }
    .filter-reset:hover { border-color: var(--pink); color: var(--pink); }

    /* ‚îÄ‚îÄ STATS SCREEN ‚îÄ‚îÄ */
    #screen-stats { padding: 18px; gap: 16px; }

    .stats-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
    }

    .stats-card-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-dim);
      margin-bottom: 14px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: var(--font-mono);
    }
    .stats-card-title::before { content: '// '; color: var(--border); }

    .stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .stat-mini {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 12px;
      text-align: center;
    }
    .stat-mini .num {
      font-size: 26px;
      font-weight: 700;
      color: var(--accent);
      font-family: var(--font-mono);
      line-height: 1;
    }
    .stat-mini .lbl {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 5px;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-family: var(--font-mono);
    }

    canvas.chart-canvas { max-height: 220px; }

    #wordcloud-canvas {
      width: 100%;
      height: 200px;
      border-radius: var(--radius-sm);
    }

    /* ‚îÄ‚îÄ HISTORY SCREEN ‚îÄ‚îÄ */
    #screen-history { padding: 18px; gap: 10px; }

    .history-item {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px;
      cursor: pointer;
      transition: border-color 0.15s;
      position: relative;
      overflow: hidden;
    }
    .history-item::before {
      content: '>';
      position: absolute;
      left: 14px; top: 14px;
      color: var(--accent);
      font-family: var(--font-mono);
      font-size: 11px;
      opacity: 0;
      transition: opacity 0.15s;
    }
    .history-item:active { border-color: var(--accent); }
    .history-item:active::before { opacity: 1; }
    .history-quote {
      font-family: var(--font-mono);
      font-size: 13px;
      font-style: italic;
      font-weight: 300;
      color: var(--text);
      line-height: 1.6;
    }
    .history-author {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 8px;
      font-family: var(--font-mono);
    }
    .history-author::before { content: '‚Äî '; color: var(--accent); }

    /* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
    .bottom-nav {
      display: flex;
      border-top: 1px solid var(--border);
      background: rgba(13,15,26,0.97);
      padding-bottom: var(--safe-bottom);
      flex-shrink: 0;
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 10px 0 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 9px;
      font-weight: 500;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      transition: color 0.15s;
      -webkit-tap-highlight-color: transparent;
      position: relative;
    }
    .nav-btn .nav-icon { font-size: 18px; line-height: 1; }
    .nav-btn.active { color: var(--accent); }
    .nav-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0; left: 25%; right: 25%;
      height: 2px;
      background: var(--accent);
      border-radius: 1px;
      box-shadow: 0 0 8px var(--accent);
    }

    /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--text-dim);
      padding: 40px;
      text-align: center;
      font-family: var(--font-mono);
    }
    .empty-state .empty-icon { font-size: 40px; opacity: 0.5; }
    .empty-state p { font-size: 12px; line-height: 1.8; }

    /* ‚îÄ‚îÄ MODAL / SHEET ‚îÄ‚îÄ */
    .sheet-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100;
      backdrop-filter: blur(6px);
    }
    .sheet-overlay.open { display: flex; align-items: flex-end; }

    .sheet {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 18px 18px 0 0;
      padding: 18px 18px calc(var(--safe-bottom) + 22px);
      animation: sheetUp 0.28s cubic-bezier(0.32, 0.72, 0, 1);
    }

    @keyframes sheetUp {
      from { transform: translateY(100%); }
      to   { transform: translateY(0); }
    }

    .sheet-handle {
      width: 32px; height: 3px;
      background: var(--border);
      border-radius: 2px;
      margin: 0 auto 18px;
    }

    .sheet-title {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
      font-family: var(--font-mono);
      margin-bottom: 14px;
    }
    .sheet-title::before { content: '// '; color: var(--border); }

    .sheet-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 55vh;
      overflow-y: auto;
    }

    .sheet-item {
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--card);
      font-size: 12px;
      font-family: var(--font-mono);
      font-style: italic;
      font-weight: 300;
      cursor: pointer;
      transition: all 0.12s;
      line-height: 1.5;
      color: var(--text);
    }
    .sheet-item:active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

    /* ‚îÄ‚îÄ DATA LOAD SCREEN ‚îÄ‚îÄ */
    .load-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 18px;
      padding: 32px 24px;
      text-align: center;
    }

    .load-icon { font-size: 44px; opacity: 0.7; }

    .load-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--accent);
      font-family: var(--font-mono);
    }
    .load-title::before { content: '// '; color: var(--text-dim); font-weight: 300; }

    .load-subtitle {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.8;
      font-family: var(--font-mono);
      max-width: 320px;
    }

    .btn-upload {
      padding: 14px 24px;
      border-radius: var(--radius);
      border: 1px dashed var(--accent);
      background: var(--accent-dim);
      color: var(--accent);
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 1.5px;
      cursor: pointer;
      transition: all 0.15s;
      width: 100%;
      text-transform: uppercase;
      box-shadow: var(--accent-glow);
    }
    .btn-upload:active { background: var(--accent); color: var(--bg); }

    #file-input { display: none; }

    .demo-btn {
      padding: 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 1px;
      cursor: pointer;
      width: 100%;
      transition: border-color 0.15s, color 0.15s;
    }
    .demo-btn:hover { border-color: var(--green); color: var(--green); }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    .toast {
      position: fixed;
      bottom: calc(var(--safe-bottom) + 90px);
      left: 50%;
      transform: translateX(-50%) translateY(16px);
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--accent);
      padding: 9px 18px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-family: var(--font-mono);
      font-weight: 500;
      letter-spacing: 0.5px;
      opacity: 0;
      transition: all 0.22s;
      pointer-events: none;
      white-space: nowrap;
      z-index: 200;
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
    }
    .toast::before { content: '> '; color: var(--green); }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* ‚îÄ‚îÄ No data overlay ‚îÄ‚îÄ */
    #no-data-screen { display: none; }
    #no-data-screen.active { display: flex; }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes glitch {
      0%,100% { transform: translate(0); }
      20%      { transform: translate(-2px, 1px); }
      40%      { transform: translate(2px, -1px); }
      60%      { transform: translate(-1px, 2px); }
      80%      { transform: translate(1px, -2px); }
    }
    .quote-text.loading { animation: glitch 0.3s ease; opacity: 0.1; }
  </style>
</head>
<body>

<div class="app" id="app">

  <!-- HEADER -->
  <header class="header">
    <span class="app-name" id="app-title">quotes</span>
    <div class="header-actions">
      <button class="icon-btn" onclick="openHistorySheet()" title="Favoris">‚ô°</button>
      <button class="icon-btn" onclick="showLoadScreen()" title="Charger donn√©es">‚äû</button>
    </div>
  </header>

  <!-- SCREEN : DATA LOAD -->
  <div class="screen active" id="no-data-screen">
    <div class="load-area">
      <div class="load-icon">‚óà</div>
      <div class="load-title">init.data</div>
      <div class="load-subtitle">Importez votre fichier CSV/TSV depuis Google Sheets, ou lancez la d√©monstration.</div>
      <button class="btn-upload" onclick="document.getElementById('file-input').click()">
        import_file( CSV | TSV | JSON )
      </button>
      <input type="file" id="file-input" accept=".csv,.tsv,.json" onchange="handleFileLoad(event)" />
      <button class="demo-btn" onclick="loadDemoData()">run_demo() ‚Üí 12 phrases</button>
      <p style="font-size:11px;color:var(--text-dim);line-height:2;font-family:var(--font-mono);">
        <span style="color:var(--green)">// recommand√© :</span> √©vite les bugs virgules<br>
        Google Sheets ‚Üí Fichier ‚Üí T√©l√©charger ‚Üí <strong style="color:var(--text)">TSV</strong>
      </p>
    </div>
  </div>

  <!-- SCREEN : QUOTE -->
  <div class="screen" id="screen-quote">
    <div class="quote-area">
      <div class="quote-line-num" id="quote-line-num">line 001 / 000</div>
      <span class="quote-mark">"</span>
      <p class="quote-text" id="quote-text">Appuyez sur le bouton pour d√©couvrir une phrase.<span class="cursor-blink"></span></p>
      <div class="quote-meta">
        <div class="meta-author" id="meta-author">‚Äî</div>
        <div class="meta-secondary" id="meta-secondary"></div>
      </div>
    </div>

    <!-- Chips masquables -->
    <div class="chips-row" id="chips-row"></div>

    <!-- D√©tails panel -->
    <div class="details-panel" id="details-panel"></div>

    <!-- Bottom bar -->
    <div class="bottom-bar">
      <button class="btn-fav" id="btn-fav" onclick="toggleFav()" title="Favoris">‚ô°</button>
      <button class="btn-random" onclick="showRandom()">
        random_quote()
      </button>
    </div>
  </div>

  <!-- SCREEN : FILTER -->
  <div class="screen" id="screen-filter">
    <div class="filter-section">
      <div class="filter-title">Recherche</div>
      <input class="filter-input" type="search" placeholder="grep 'mot cl√©' quotes.db" id="search-input" oninput="applyFilters()" />
    </div>
    <div class="filter-section">
      <div class="filter-title">Auteur</div>
      <div class="filter-chips" id="filter-authors"></div>
    </div>
    <div class="filter-section">
      <div class="filter-title">Cat√©gorie principale</div>
      <div class="filter-chips" id="filter-main-cats"></div>
    </div>
    <div class="filter-section">
      <div class="filter-title">Cat√©gorie secondaire</div>
      <div class="filter-chips" id="filter-second-cats"></div>
    </div>
    <div class="filter-section">
      <div class="filter-title">Lieu</div>
      <div class="filter-chips" id="filter-locations"></div>
    </div>
    <div class="filter-section">
      <div class="filter-title">Alcool</div>
      <div class="filter-chips" id="filter-alcohol"></div>
    </div>
    <button class="filter-reset" onclick="resetFilters()">reset_filters()</button>
    <div style="font-size:11px;color:var(--text-dim);text-align:center;font-family:var(--font-mono);" id="filter-count"></div>
  </div>

  <!-- SCREEN : STATS -->
  <div class="screen" id="screen-stats">
    <div class="stats-card">
      <div class="stats-card-title">overview</div>
      <div class="stat-grid" id="stat-overview"></div>
    </div>
    <div class="stats-card">
      <div class="stats-card-title">phrases par personne</div>
      <canvas class="chart-canvas" id="chart-persons"></canvas>
    </div>
    <div class="stats-card">
      <div class="stats-card-title">cat√©gories</div>
      <canvas class="chart-canvas" id="chart-cats"></canvas>
    </div>
    <div class="stats-card">
      <div class="stats-card-title">activit√© par heure</div>
      <canvas class="chart-canvas" id="chart-hours"></canvas>
    </div>
    <div class="stats-card">
      <div class="stats-card-title">top lieux</div>
      <canvas class="chart-canvas" id="chart-locations"></canvas>
    </div>
    <div class="stats-card">
      <div class="stats-card-title">word_cloud()</div>
      <canvas id="wordcloud-canvas"></canvas>
    </div>
  </div>

  <!-- SCREEN : HISTORY -->
  <div class="screen" id="screen-history">
    <div class="empty-state" id="history-empty">
      <div class="empty-icon">‚óå</div>
      <p>// aucun historique<br>tirez des phrases al√©atoires<br>pour les voir appara√Ætre ici</p>
    </div>
    <div id="history-list" style="padding:18px;display:flex;flex-direction:column;gap:10px;"></div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav" id="bottom-nav">
    <button class="nav-btn active" onclick="navigate('quote')" id="nav-quote">
      <span class="nav-icon">‚óà</span>phrase
    </button>
    <button class="nav-btn" onclick="navigate('filter')" id="nav-filter">
      <span class="nav-icon">‚äü</span>filtres
    </button>
    <button class="nav-btn" onclick="navigate('stats')" id="nav-stats">
      <span class="nav-icon">‚óë</span>stats
    </button>
    <button class="nav-btn" onclick="navigate('history')" id="nav-history">
      <span class="nav-icon">‚óã</span>log
    </button>
  </nav>

</div>

<!-- FAVORITES SHEET -->
<div class="sheet-overlay" id="history-sheet" onclick="closeHistorySheet(event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">favoris</div>
    <div class="sheet-list" id="fav-list"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allQuotes = [];
let filteredQuotes = [];
let currentQuote = null;
let sessionHistory = [];
let favorites = JSON.parse(localStorage.getItem('qapp_favs') || '[]');
let activeFilters = { authors:[], mainCats:[], secondCats:[], locations:[], alcohol:[], search:'' };
let charts = {};
let dataLoaded = false;

// Column mapping (flexible)
const COL = {
  ts:        ['Horodateur','horodateur','timestamp'],
  quote:     ['Insert quote','insert quote','Quote','quote','phrase'],
  name:      ['Insert name (e.g: John. D)','Insert name','name','auteur','Auteur'],
  location:  ['Insert location','Location','lieu','Lieu'],
  mainCat:   ['Main category','main category','Cat√©gorie principale'],
  secondCat: ['Second category','second category','Cat√©gorie secondaire'],
  alcohol:   ['Under alcohol ?','Under alcohol','alcool','Alcool'],
  context:   ['Context','context','Contexte'],
  wam:       ['Si wam, avec qui ?','Si wam','wam'],
};

function getCol(row, keys) {
  for (const k of keys) {
    if (row[k] !== undefined && row[k] !== null && row[k] !== '') return row[k];
  }
  // Case insensitive fallback
  const rowLower = Object.fromEntries(Object.entries(row).map(([k,v])=>[k.toLowerCase(),v]));
  for (const k of keys) {
    if (rowLower[k.toLowerCase()] !== undefined) return rowLower[k.toLowerCase()];
  }
  return '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATE PARSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseDate(str) {
  if (!str) return null;
  str = String(str).trim();
  // DD/MM/YYYY HH:MM:SS or DD/MM/YYYY HH:MM
  let m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})[\s,T](\d{2}):(\d{2})/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1], +m[4], +m[5]);
  // ISO
  const d = new Date(str);
  return isNaN(d) ? null : d;
}

function formatDate(str) {
  const d = parseDate(str);
  if (!d) return str;
  return d.toLocaleDateString('fr-FR', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * D√©tecte l'encodage et parse le fichier de mani√®re robuste.
 *
 * Strat√©gie CSV/TSV :
 *  1. Si l'extension est .tsv ‚Üí s√©parateur tabulation
 *  2. Sinon on laisse PapaParse d√©tecter automatiquement le s√©parateur
 *     (il teste virgule, point-virgule, tabulation)
 *  3. Les guillemets doubles autour des champs (standard RFC 4180) sont
 *     g√©r√©s nativement par PapaParse ‚Üí virgules dans les phrases OK.
 *  4. Lecture en ArrayBuffer pour d√©tecter le BOM UTF-8 (0xEF 0xBB 0xBF)
 *     produit par Google Sheets et Excel ‚Üí d√©codage propre des accents.
 */
function handleFileLoad(e) {
  const file = e.target.files[0];
  if (!file) return;

  // R√©initialise l'input pour permettre de recharger le m√™me fichier
  e.target.value = '';

  const isTsv  = file.name.endsWith('.tsv');
  const isJson = file.name.endsWith('.json');

  // On lit en ArrayBuffer pour g√©rer le BOM manuellement
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const buffer = ev.target.result;

      if (isJson) {
        const text = decodeBuffer(buffer);
        const data = JSON.parse(text);
        initData(Array.isArray(data) ? data : data.data || []);
        return;
      }

      const text = decodeBuffer(buffer);

      const papaOpts = {
        header: true,
        skipEmptyLines: true,
        quoteChar: '"',      // RFC 4180 : guillemets doubles encadrent les champs avec virgules
        escapeChar: '"',     // guillemet double doubl√© = guillemet litt√©ral dans le champ
        dynamicTyping: false, // tout en cha√Æne, on g√®re les types nous-m√™mes
        transformHeader: h => h.trim(), // supprime les espaces parasites en en-t√™te
        transform: v => v.trim(),       // supprime les espaces parasites dans les valeurs
      };

      if (isTsv) {
        papaOpts.delimiter = '\t';
      } else {
        // D√©tection automatique : PapaParse teste ',', ';', '\t', '|'
        papaOpts.delimiter = '';
      }

      const result = Papa.parse(text, papaOpts);

      if (result.errors.length) {
        console.warn('PapaParse warnings:', result.errors);
        // On continue quand m√™me si des donn√©es ont √©t√© pars√©es
      }

      if (!result.data.length) {
        showToast('‚ùå Fichier vide ou non reconnu');
        return;
      }

      initData(result.data);

    } catch(err) {
      console.error(err);
      showToast('‚ùå Erreur de lecture ‚Äî v√©rifiez le format du fichier');
    }
  };

  reader.readAsArrayBuffer(file);
}

/**
 * D√©code un ArrayBuffer en texte UTF-8 en g√©rant le BOM (Byte Order Mark).
 * Google Sheets et Excel ajoutent parfois 3 octets BOM en d√©but de fichier
 * (0xEF 0xBB 0xBF) qui sinon s'affichent comme le caract√®re √Ø¬ª¬ø en d√©but
 * de premi√®re colonne et cassent la reconnaissance des en-t√™tes.
 */
function decodeBuffer(buffer) {
  const bytes = new Uint8Array(buffer);
  // D√©tecte BOM UTF-8
  const hasBom = bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF;
  const slice  = hasBom ? buffer.slice(3) : buffer;
  return new TextDecoder('utf-8').decode(slice);
}

function loadDemoData() {
  const demo = [
    { 'Horodateur':'15/03/2024 21:34:00','Insert quote':'Pourquoi faire simple quand on peut faire compliqu√©, et finalement regretter les deux ?','Insert name (e.g: John. D)':'Alex. M','Insert location':'Salon de Tom','Main category':'Philosophie','Second category':'Humour','Under alcohol ?':'Oui','Context':'Discussion post-d√Æner','Si wam, avec qui ?':'Tom, Julie' },
    { 'Horodateur':'20/04/2024 23:11:00','Insert quote':'J\'avais un plan, mais je l\'ai perdu dans ma troisi√®me bi√®re.','Insert name (e.g: John. D)':'Julie. R','Insert location':'Bar du Coin','Main category':'Humour','Second category':'Soir√©e','Under alcohol ?':'Oui','Context':'Soir√©e d\'anniversaire','Si wam, avec qui ?':'Alex, Tom, L√©a' },
    { 'Horodateur':'02/05/2024 14:22:00','Insert quote':'Le soleil se couche mais nos ambitions restent debout, du moins jusqu\'√† ce qu\'on s\'assoie.','Insert name (e.g: John. D)':'Tom. B','Insert location':'Terrasse','Main category':'Philosophie','Second category':'Nature','Under alcohol ?':'Non','Context':'Coucher de soleil','Si wam, avec qui ?':'' },
    { 'Horodateur':'14/06/2024 20:05:00','Insert quote':'Je ne suis pas en retard, le temps est en avance.','Insert name (e.g: John. D)':'L√©a. C','Insert location':'Caf√© Voltaire','Main category':'Humour','Second category':'Temps','Under alcohol ?':'Non','Context':'Rendez-vous rat√©','Si wam, avec qui ?':'Alex. M' },
    { 'Horodateur':'29/06/2024 22:40:00','Insert quote':'On a tous un plan jusqu\'√† ce qu\'on re√ßoive la facture.','Insert name (e.g: John. D)':'Alex. M','Insert location':'Restaurant Le Gaulois','Main category':'Sagesse','Second category':'Argent','Under alcohol ?':'Oui','Context':'Addition de fin de soir√©e','Si wam, avec qui ?':'Toute la bande' },
    { 'Horodateur':'11/07/2024 19:30:00','Insert quote':'Le bonheur, c\'est quand le WiFi se connecte du premier coup.','Insert name (e.g: John. D)':'Tom. B','Insert location':'Appartement de Julie','Main category':'Tech','Second category':'Humour','Under alcohol ?':'Non','Context':'Soir√©e Netflix','Si wam, avec qui ?':'Julie. R' },
    { 'Horodateur':'03/08/2024 01:15:00','Insert quote':'J\'ai deux humeurs : fatigu√© et tr√®s fatigu√©. Ce soir c\'est la deuxi√®me.','Insert name (e.g: John. D)':'Julie. R','Insert location':'Plage de Pampelonne','Main category':'Humour','Second category':'Fatigue','Under alcohol ?':'Oui','Context':'Retour de plage','Si wam, avec qui ?':'Alex, Tom, L√©a' },
    { 'Horodateur':'25/09/2024 18:00:00','Insert quote':'Les meilleures id√©es arrivent sous la douche, mais le carnet de notes y est pas √©tanche.','Insert name (e.g: John. D)':'L√©a. C','Insert location':'Chez L√©a','Main category':'Cr√©ativit√©','Second category':'Humour','Under alcohol ?':'Non','Context':'Discussion cr√©a','Si wam, avec qui ?':'' },
    { 'Horodateur':'10/10/2024 22:20:00','Insert quote':'Optimiste : quelqu\'un qui n\'a pas encore lu les nouvelles.','Insert name (e.g: John. D)':'Alex. M','Insert location':'Bar du Coin','Main category':'Philosophie','Second category':'Politique','Under alcohol ?':'Oui','Context':'D√©bat houleux','Si wam, avec qui ?':'Tom. B' },
    { 'Horodateur':'31/12/2024 23:59:00','Insert quote':'Bonne ann√©e ! Ou du moins, une ann√©e diff√©rente.','Insert name (e.g: John. D)':'Tom. B','Insert location':'Toit-terrasse de Alex','Main category':'Humour','Second category':'Temps','Under alcohol ?':'Oui','Context':'R√©veillon','Si wam, avec qui ?':'Tout le monde' },
    { 'Horodateur':'14/01/2025 20:45:00','Insert quote':'La motivation c\'est comme le caf√© : √ßa dure deux heures et ensuite il faut en reprendre.','Insert name (e.g: John. D)':'Julie. R','Insert location':'Co-working Space','Main category':'Sagesse','Second category':'Travail','Under alcohol ?':'Non','Context':'Session boulot','Si wam, avec qui ?':'' },
    { 'Horodateur':'28/02/2025 21:00:00','Insert quote':'Si la vie √©tait un film, je demanderais √† revoir le sc√©nario.','Insert name (e.g: John. D)':'L√©a. C','Insert location':'Cin√©ma Lumi√®re','Main category':'Philosophie','Second category':'Humour','Under alcohol ?':'Non','Context':'Apr√®s la s√©ance','Si wam, avec qui ?':'Alex. M, Tom. B' },
  ];
  initData(demo);
}

function initData(data) {
  allQuotes = data.filter(r => getCol(r, COL.quote));
  filteredQuotes = [...allQuotes];
  dataLoaded = true;

  // Hide load screen, show main app
  document.getElementById('no-data-screen').classList.remove('active');
  document.getElementById('bottom-nav').style.display = '';
  navigate('quote');
  buildFilters();
  showRandom();
  showToast(`‚úì ${allQuotes.length} phrases charg√©es`);
}

function showLoadScreen() {
  if (!dataLoaded) return;
  // re-show load screen
  allQuotes = [];
  filteredQuotes = [];
  dataLoaded = false;
  document.getElementById('no-data-screen').classList.add('active');
  hideAllScreens();
  document.getElementById('bottom-nav').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function hideAllScreens() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
}

function navigate(screen) {
  if (!dataLoaded && screen !== 'load') return;
  hideAllScreens();
  document.getElementById('screen-' + screen).classList.add('active');
  const navBtn = document.getElementById('nav-' + screen);
  if (navBtn) navBtn.classList.add('active');

  if (screen === 'stats') buildStats();
  if (screen === 'history') renderHistory();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QUOTE DISPLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showRandom() {
  if (!filteredQuotes.length) {
    showToast('Aucune phrase avec ces filtres');
    return;
  }
  const idx = Math.floor(Math.random() * filteredQuotes.length);
  displayQuote(filteredQuotes[idx]);
}

function displayQuote(q) {
  currentQuote = q;
  // Update line number
  const qIdx = filteredQuotes.indexOf(q) + 1 || '?';
  const lineEl = document.getElementById('quote-line-num');
  if (lineEl) lineEl.textContent = 'line ' + String(qIdx).padStart(3,'0') + ' / ' + String(filteredQuotes.length).padStart(3,'0');
  const el = document.getElementById('quote-text');
  el.classList.add('loading');
  setTimeout(() => {
    el.innerHTML = getCol(q, COL.quote) + '<span class="cursor-blink"></span>';
    el.classList.remove('loading');
  }, 150);

  const name = getCol(q, COL.name);
  const loc  = getCol(q, COL.location);
  const ts   = getCol(q, COL.ts);

  document.getElementById('meta-author').textContent = name ? `‚Äî ${name}` : '‚Äî';

  const secEl = document.getElementById('meta-secondary');
  secEl.innerHTML = '';
  if (loc) secEl.innerHTML += `<span>${loc}</span>`;
  if (ts)  secEl.innerHTML += `<span>${formatDate(ts)}</span>`;

  // Add to history
  sessionHistory.unshift(q);
  if (sessionHistory.length > 50) sessionHistory.pop();

  // Fav state
  updateFavBtn();

  // Build chips
  buildChips(q);
}

function buildChips(q) {
  const row = document.getElementById('chips-row');
  const panel = document.getElementById('details-panel');
  row.innerHTML = '';
  panel.innerHTML = '';
  panel.classList.remove('open');

  const ctx      = getCol(q, COL.context);
  const mainCat  = getCol(q, COL.mainCat);
  const secondCat= getCol(q, COL.secondCat);
  const alcohol  = getCol(q, COL.alcohol);
  const wam      = getCol(q, COL.wam);

  const chips = [];
  const details = [];

  if (ctx) {
    chips.push({ icon:'üí¨', label:'Contexte', id:'ctx' });
    details.push({ icon:'üí¨', label:'Contexte', value: ctx, id:'ctx' });
  }
  if (mainCat || secondCat) {
    chips.push({ icon:'üè∑', label:'Cat√©gorie', id:'cat' });
    if (mainCat)   details.push({ icon:'üè∑', label:'Cat√©gorie', value: mainCat + (secondCat ? ` ¬∑ ${secondCat}` : ''), id:'cat' });
  }
  if (alcohol) {
    const isYes = /oui|yes|true/i.test(alcohol);
    chips.push({ icon: isYes ? 'üç∫' : 'üíß', label: isYes ? 'Avec alcool' : 'Sans alcool', id:'alc' });
    details.push({ icon: isYes ? 'üç∫' : 'üíß', label:'Alcool', value: `<span class="alcohol-badge ${isYes?'yes':'no'}">${alcohol}</span>`, id:'alc', html:true });
  }
  if (wam) {
    chips.push({ icon:'üë•', label:'Avec qui', id:'wam' });
    details.push({ icon:'üë•', label:'Avec qui', value: wam, id:'wam' });
  }

  if (!details.length) return;

  // Render single "Voir d√©tails" chip
  const masterChip = document.createElement('button');
  masterChip.className = 'chip';
  masterChip.innerHTML = `<span>‚ÑπÔ∏é</span> Voir les d√©tails`;
  masterChip.onclick = () => {
    const open = panel.classList.toggle('open');
    masterChip.classList.toggle('active', open);
  };
  row.appendChild(masterChip);

  // Also individual chips
  chips.forEach(c => {
    const chip = document.createElement('button');
    chip.className = 'chip';
    chip.innerHTML = `<span>${c.icon}</span> ${c.label}`;
    chip.onclick = () => {
      const el = panel.querySelector(`[data-id="${c.id}"]`);
      if (!panel.classList.contains('open')) panel.classList.add('open');
      if (el) el.scrollIntoView({ behavior:'smooth', block:'nearest' });
      chip.classList.add('active');
      setTimeout(() => chip.classList.remove('active'), 600);
    };
    row.appendChild(chip);
  });

  // Render detail rows
  details.forEach(d => {
    const row_el = document.createElement('div');
    row_el.className = 'detail-row';
    row_el.dataset.id = d.id;
    row_el.innerHTML = `
      <span class="detail-icon">${d.icon}</span>
      <div><span class="detail-label">${d.label} :</span>
      ${d.html ? d.value : `<span class="detail-value">${d.value}</span>`}
      </div>`;
    panel.appendChild(row_el);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FAVORITES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleFav() {
  if (!currentQuote) return;
  const key = getCol(currentQuote, COL.quote);
  const idx = favorites.findIndex(f => getCol(f, COL.quote) === key);
  if (idx === -1) {
    favorites.push(currentQuote);
    showToast('‚ù§Ô∏è Ajout√© aux favoris');
  } else {
    favorites.splice(idx, 1);
    showToast('Retir√© des favoris');
  }
  localStorage.setItem('qapp_favs', JSON.stringify(favorites));
  updateFavBtn();
}

function updateFavBtn() {
  if (!currentQuote) return;
  const key = getCol(currentQuote, COL.quote);
  const isFav = favorites.some(f => getCol(f, COL.quote) === key);
  const btn = document.getElementById('btn-fav');
  btn.textContent = isFav ? '‚ô•' : '‚ô°';
  btn.classList.toggle('active', isFav);
}

function openHistorySheet() {
  const list = document.getElementById('fav-list');
  list.innerHTML = '';
  if (!favorites.length) {
    list.innerHTML = '<p style="color:var(--ink-light);font-size:14px;text-align:center;padding:20px">Aucun favori pour l\'instant</p>';
  } else {
    favorites.forEach(q => {
      const item = document.createElement('div');
      item.className = 'sheet-item';
      item.textContent = getCol(q, COL.quote);
      item.onclick = () => { displayQuote(q); navigate('quote'); closeHistorySheet(); };
      list.appendChild(item);
    });
  }
  document.getElementById('history-sheet').classList.add('open');
}

function closeHistorySheet(e) {
  if (!e || e.target === document.getElementById('history-sheet')) {
    document.getElementById('history-sheet').classList.remove('open');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HISTORY SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistory() {
  const list = document.getElementById('history-list');
  const empty = document.getElementById('history-empty');
  list.innerHTML = '';
  if (!sessionHistory.length) { empty.style.display = 'flex'; return; }
  empty.style.display = 'none';
  sessionHistory.forEach(q => {
    const item = document.createElement('div');
    item.className = 'history-item';
    item.innerHTML = `<div class="history-quote">${getCol(q, COL.quote)}</div>
      <div class="history-author">‚Äî ${getCol(q, COL.name) || '?'} ¬∑ ${getCol(q, COL.location) || ''}</div>`;
    item.onclick = () => { displayQuote(q); navigate('quote'); };
    list.appendChild(item);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildFilters() {
  const uniq = (key) => [...new Set(allQuotes.map(q => getCol(q, key)).filter(Boolean))].sort();

  buildChipFilter('filter-authors', uniq(COL.name), 'authors');
  buildChipFilter('filter-main-cats', uniq(COL.mainCat), 'mainCats');
  buildChipFilter('filter-second-cats', uniq(COL.secondCat), 'secondCats');
  buildChipFilter('filter-locations', uniq(COL.location), 'locations');
  buildChipFilter('filter-alcohol', uniq(COL.alcohol), 'alcohol');
}

function buildChipFilter(containerId, values, filterKey) {
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  values.forEach(v => {
    const chip = document.createElement('button');
    chip.className = 'chip';
    chip.textContent = v;
    chip.onclick = () => {
      chip.classList.toggle('active');
      const arr = activeFilters[filterKey];
      const idx = arr.indexOf(v);
      if (idx === -1) arr.push(v); else arr.splice(idx, 1);
      applyFilters();
    };
    el.appendChild(chip);
  });
}

function applyFilters() {
  activeFilters.search = document.getElementById('search-input').value.toLowerCase();
  filteredQuotes = allQuotes.filter(q => {
    if (activeFilters.authors.length && !activeFilters.authors.includes(getCol(q, COL.name))) return false;
    if (activeFilters.mainCats.length && !activeFilters.mainCats.includes(getCol(q, COL.mainCat))) return false;
    if (activeFilters.secondCats.length && !activeFilters.secondCats.includes(getCol(q, COL.secondCat))) return false;
    if (activeFilters.locations.length && !activeFilters.locations.includes(getCol(q, COL.location))) return false;
    if (activeFilters.alcohol.length && !activeFilters.alcohol.includes(getCol(q, COL.alcohol))) return false;
    if (activeFilters.search) {
      const haystack = (getCol(q, COL.quote) + ' ' + getCol(q, COL.context)).toLowerCase();
      if (!haystack.includes(activeFilters.search)) return false;
    }
    return true;
  });
  document.getElementById('filter-count').textContent = `${filteredQuotes.length} phrase${filteredQuotes.length > 1 ? 's' : ''} disponible${filteredQuotes.length > 1 ? 's' : ''}`;
}

function resetFilters() {
  activeFilters = { authors:[], mainCats:[], secondCats:[], locations:[], alcohol:[], search:'' };
  document.getElementById('search-input').value = '';
  document.querySelectorAll('#screen-filter .chip').forEach(c => c.classList.remove('active'));
  filteredQuotes = [...allQuotes];
  document.getElementById('filter-count').textContent = `${filteredQuotes.length} phrases disponibles`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CHART_COLORS = ['#7c6af7','#4ade80','#f472b6','#22d3ee','#fbbf24','#a78bfa','#34d399','#fb7185'];

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

function buildStats() {
  if (!allQuotes.length) return;

  // Overview
  const alcoholCount = allQuotes.filter(q => /oui|yes|true/i.test(getCol(q, COL.alcohol))).length;
  const avgLen = Math.round(allQuotes.reduce((s,q) => s + getCol(q,COL.quote).length, 0) / allQuotes.length);
  const uniqAuthors = new Set(allQuotes.map(q=>getCol(q,COL.name))).size;
  const uniqLocs = new Set(allQuotes.map(q=>getCol(q,COL.location))).size;

  document.getElementById('stat-overview').innerHTML = `
    <div class="stat-mini"><div class="num">${allQuotes.length}</div><div class="lbl">Phrases</div></div>
    <div class="stat-mini"><div class="num">${uniqAuthors}</div><div class="lbl">Auteurs</div></div>
    <div class="stat-mini"><div class="num">${alcoholCount}</div><div class="lbl">Avec alcool</div></div>
    <div class="stat-mini"><div class="num">${avgLen}</div><div class="lbl">Longueur moy.</div></div>
  `;

  // Persons chart
  const personCounts = {};
  allQuotes.forEach(q => { const n = getCol(q,COL.name)||'?'; personCounts[n] = (personCounts[n]||0)+1; });
  const personSorted = Object.entries(personCounts).sort((a,b)=>b[1]-a[1]);
  destroyChart('persons');
  charts.persons = new Chart(document.getElementById('chart-persons'), {
    type: 'bar',
    data: { labels: personSorted.map(e=>e[0]), datasets:[{ data: personSorted.map(e=>e[1]), backgroundColor: CHART_COLORS, borderRadius:8, borderSkipped:false }]},
    options: chartOpts('Phrases')
  });

  // Main cats
  const catCounts = {};
  allQuotes.forEach(q => { const c = getCol(q,COL.mainCat)||'Autre'; catCounts[c]=(catCounts[c]||0)+1; });
  const catSorted = Object.entries(catCounts).sort((a,b)=>b[1]-a[1]);
  destroyChart('cats');
  charts.cats = new Chart(document.getElementById('chart-cats'), {
    type: 'doughnut',
    data: { labels: catSorted.map(e=>e[0]), datasets:[{ data: catSorted.map(e=>e[1]), backgroundColor: CHART_COLORS, borderWidth:2, borderColor:'#fff' }]},
    options: { ...chartOpts(), plugins:{ legend:{ position:'right', labels:{ font:{family:'JetBrains Mono',size:10}, color:'#4a4a6a', boxWidth:12 }}, tooltip:{ callbacks:{ label: ctx => ` ${ctx.label}: ${ctx.raw}` }}}}
  });

  // Hours
  const hourCounts = Array(24).fill(0);
  allQuotes.forEach(q => { const d = parseDate(getCol(q,COL.ts)); if(d) hourCounts[d.getHours()]++; });
  destroyChart('hours');
  charts.hours = new Chart(document.getElementById('chart-hours'), {
    type: 'line',
    data: { labels: Array.from({length:24},(_,i)=>`${i}h`), datasets:[{ data:hourCounts, borderColor:'#5b4ff5', backgroundColor:'rgba(91,79,245,0.1)', fill:true, tension:0.4, pointRadius:3, pointBackgroundColor:'#5b4ff5' }]},
    options: chartOpts('Phrases')
  });

  // Locations
  const locCounts = {};
  allQuotes.forEach(q => { const l = getCol(q,COL.location)||'?'; locCounts[l]=(locCounts[l]||0)+1; });
  const locSorted = Object.entries(locCounts).sort((a,b)=>b[1]-a[1]).slice(0,7);
  destroyChart('locations');
  charts.locations = new Chart(document.getElementById('chart-locations'), {
    type: 'bar',
    data: { labels: locSorted.map(e=>e[0]), datasets:[{ data:locSorted.map(e=>e[1]), backgroundColor: CHART_COLORS, borderRadius:8, borderSkipped:false }]},
    options: { ...chartOpts('Phrases'), indexAxis:'y' }
  });

  // Wordcloud
  const wordFreq = {};
  const stopwords = new Set(['le','la','les','de','du','des','un','et','en','√†','au','aux','je','il','elle','on','nous','vous','ils','elles','que','qui','ce','se','sa','si','pas','ne','mais','ou','donc','or','ni','car','plus','tout','dans','sur','par','avec','pour','est','son','une','mon','ma','mes','ses','leur','leurs','cette','ces','cet','vous','nous','apr√®s','avant','tr√®s']);
  allQuotes.forEach(q => {
    getCol(q,COL.quote).toLowerCase().replace(/[^a-z√†√¢√§√©√®√™√´√Æ√Ø√¥√π√ª√º√ß\s]/g,' ').split(/\s+/).forEach(w => {
      if (w.length > 3 && !stopwords.has(w)) wordFreq[w] = (wordFreq[w]||0)+1;
    });
  });
  const words = Object.entries(wordFreq).sort((a,b)=>b[1]-a[1]).slice(0,60);
  try {
    WordCloud(document.getElementById('wordcloud-canvas'), {
      list: words,
      gridSize: 6,
      weightFactor: s => Math.max(10, s * 8),
      fontFamily: 'JetBrains Mono',
      color: () => CHART_COLORS[Math.floor(Math.random()*CHART_COLORS.length)],
      backgroundColor: 'transparent',
    });
  } catch(e) {}
}

function chartOpts(yLabel) {
  return {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: { display: false },
      tooltip: { callbacks: { label: ctx => ` ${ctx.raw} phrase${ctx.raw > 1 ? 's' : ''}` } }
    },
    scales: {
      x: { grid: { color:'rgba(255,255,255,0.04)' }, ticks: { font:{family:'JetBrains Mono',size:10}, color:'#4a4f6a' } },
      y: { grid: { color:'rgba(255,255,255,0.04)' }, ticks: { font:{family:'JetBrains Mono',size:10}, color:'#4a4f6a' } }
    }
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('bottom-nav').style.display = 'none';
  document.getElementById('no-data-screen').classList.add('active');

  // PWA service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if (e.key === ' ' || e.key === 'Enter') showRandom();
  });
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0d0f1a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Our Quotes" />
  <title>QuoteApp</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.jpg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <!-- Chart.js loaded lazily when Stats tab is opened -->

  <style>
    /* â”€â”€ DESIGN TOKENS â”€â”€ */
    :root {
      --bg:          #0d0f1a;
      --bg2:         #111320;
      --panel:       #151829;
      --card:        #1a1e30;
      --border:      #272c46;
      --border-glow: #7c6af744;

      --accent:      #7c6af7;
      --accent-dim:  #7c6af733;
      --accent-glow: 0 0 20px #7c6af755, 0 0 60px #7c6af722;
      --green:       #4ade80;
      --amber:       #fbbf24;
      --pink:        #f472b6;
      --cyan:        #22d3ee;

      --text:        #e8e6f4;
      --text-mid:    #9599b8;
      --text-dim:    #6d72a0;

      --font-mono:   'JetBrains Mono', 'Courier New', monospace;
      --font-body:   'DM Sans', system-ui, sans-serif;

      --radius:      14px;
      --radius-sm:   8px;
      --safe-top:    env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { overscroll-behavior: none; }
    * { -webkit-user-select: none; user-select: none; }
    input, textarea { -webkit-user-select: text; user-select: text; }

    html, body {
      height: 100%;
      font-family: var(--font-mono);
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
    }

    /* Scanline texture overlay â€” subtle, low perf impact */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.015) 2px,
        rgba(0,0,0,0.015) 4px
      );
      pointer-events: none;
      z-index: 100;
      will-change: auto;
    }

    /* â”€â”€ LAYOUT â”€â”€ */
    .app {
      display: flex;
      flex-direction: column;
      height: 100dvh;
      max-width: 480px;
      margin: 0 auto;
      background: var(--bg);
      position: relative;
      overflow: hidden;
    }

    /* â”€â”€ HEADER â”€â”€ */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: calc(var(--safe-top) + 14px) 18px 14px;
      background: rgba(13,15,26,0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      position: relative;
      z-index: 10;
      flex-shrink: 0;
    }

    .app-name {
      font-family: var(--font-mono);
      font-size: 13px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 3px;
      text-transform: uppercase;
    }

    .app-name::before {
      content: '// ';
      color: var(--text-dim);
      font-weight: 300;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-fav-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 7px 11px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--card);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: border-color 0.15s;
    }
    .btn-fav-header:active { border-color: var(--accent); }
    .btn-fav-header-icon {
      font-size: 15px;
      line-height: 1;
    }
    .btn-fav-header-label {
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-dim);
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .icon-btn {
      width: 34px; height: 34px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text-mid);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      transition: border-color 0.15s, color 0.15s, transform 0.1s;
      -webkit-tap-highlight-color: transparent;
      font-family: var(--font-mono);
    }
    .icon-btn:active { transform: scale(0.9); border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ SCREENS â”€â”€ */
    .screen {
      display: none;
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .screen.active { display: flex; flex-direction: column; }

    /* â”€â”€ QUOTE SCREEN â”€â”€ */
    #screen-quote {
      padding: 0;
      justify-content: space-between;
    }

    /* â”€â”€ QUOTE AREA : layout fixe en 3 zones â”€â”€ */
    .quote-area {
      flex: 1;
      display: grid;
      grid-template-rows: 1fr auto;
      gap: 0;
      padding: 32px 24px 20px;
      min-height: 0;
      position: relative;
    }

    /* Coins dÃ©coratifs fixes */
    .quote-area::before, .quote-area::after {
      content: '';
      position: absolute;
      width: 20px; height: 20px;
      border-color: var(--border-glow);
      border-style: solid;
      pointer-events: none;
    }
    .quote-area::before { top: 16px; left: 16px; border-width: 2px 0 0 2px; }
    .quote-area::after  { bottom: 16px; right: 16px; border-width: 0 2px 2px 0; }

    /* Zone haute : numÃ©ro de phrase (fixe) */
    .quote-line-num {
      font-size: 11px;
      color: var(--text-dim);
      letter-spacing: 1px;
      font-family: var(--font-mono);
    }

    /* Zone centrale : " + texte (scrollable si nÃ©cessaire) */
    .quote-center {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 0;
      overflow: hidden;
    }

    .quote-mark {
      font-family: var(--font-mono);
      font-size: 48px;
      line-height: 0.7;
      color: var(--accent-dim);
      margin-bottom: 14px;
      display: block;
      font-weight: 700;
      flex-shrink: 0;
    }

    .quote-text {
      font-family: var(--font-body);
      font-size: clamp(16px, 4.5vw, 21px);
      line-height: 1.75;
      color: var(--text);
      font-weight: 300;
      font-style: italic;
      position: relative;
    }

    .cursor-blink {
      display: inline-block;
      width: 2px;
      height: 1.1em;
      background: var(--accent);
      margin-left: 3px;
      vertical-align: text-bottom;
      animation: blink 1s step-end infinite;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

    /* Zone basse : auteur + badges (fixe) */
    .quote-bottom {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    /* NumÃ©ro au-dessus du sÃ©parateur, alignÃ© Ã  droite */
    .quote-bottom .quote-line-num {
      text-align: right;
      padding-bottom: 6px;
      margin-bottom: 0;
    }

    /* SÃ©parateur + contenu infos */
    .quote-bottom-inner {
      padding-top: 10px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .quote-meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .meta-author {
      font-size: 12px;
      font-weight: 500;
      color: var(--accent);
      font-family: var(--font-mono);
      letter-spacing: 0.5px;
    }
    .meta-author::before { content: '> '; color: #ffffff; }

    .meta-secondary {
      font-size: 12px;
      color: var(--text-dim);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      font-family: var(--font-mono);
    }

    .meta-secondary span { display: flex; align-items: center; gap: 4px; }
    .meta-secondary span::before { content: 'â€”'; color: var(--text-dim); opacity: 0.4; }

    /* â”€â”€ CHIPS AREA â”€â”€ */
    .chips-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-start;
      min-height: 28px; /* rÃ©serve de la hauteur mÃªme vide */
    }

    /* Animation de transition entre phrases */
    @keyframes quoteIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .quote-center.animating { animation: quoteIn 0.35s cubic-bezier(0.22,1,0.36,1) forwards; }
    .quote-bottom.animating { animation: quoteIn 0.35s cubic-bezier(0.22,1,0.36,1) 0.06s both; }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--card);
      font-size: 12px;
      font-weight: 400;
      font-family: var(--font-mono);
      color: var(--text-mid);
      cursor: pointer;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      letter-spacing: 0.3px;
    }
    .chip::before { content: '['; color: var(--text-dim); }
    .chip::after  { content: ']'; color: var(--text-dim); }
    .chip.active {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }
    .chip.active::before, .chip.active::after { color: var(--accent); }

    /* â”€â”€ BADGES TOUJOURS VISIBLES (catÃ©gorie + alcool) â”€â”€ */
    .info-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-family: var(--font-mono);
      font-weight: 500;
      letter-spacing: 0.3px;
      border: 1px solid var(--border);
    }
    .cat-badge {
      background: #6d1a2a18;
      color: #c0506a;
      border-color: #6d1a2a55;
    }
    .alc-badge.yes {
      background: #fbbf2414;
      color: var(--amber);
      border-color: #fbbf2440;
    }
    .alc-badge.no {
      background: #4ade8012;
      color: var(--green);
      border-color: #4ade8035;
    }

    /* â”€â”€ DETAILS PANEL â”€â”€ */
    .details-panel {
      display: none;
      flex-direction: column;
      gap: 8px;
      padding: 10px 0 0;
      animation: fadeIn 0.2s ease;
    }
    .details-panel.open { display: flex; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .detail-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 12px;
      font-family: var(--font-mono);
      line-height: 1.5;
    }
    .detail-label {
      color: #ffffff;
      flex-shrink: 0;
      font-size: 11px;
    }
    .detail-label::after { content: ':'; }
    .detail-value { color: var(--text-mid); }

    .alcohol-badge {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .alcohol-badge.yes { background: #fbbf2422; color: var(--amber); border: 1px solid #fbbf2444; }
    .alcohol-badge.no  { background: #4ade8022; color: var(--green);  border: 1px solid #4ade8044; }

    .vol-badge {
      background: #22d3ee18;
      color: #22d3ee;
      border: 1px solid #22d3ee33;
    }

    /* â”€â”€ BOTTOM ACTION BAR â”€â”€ */
    .bottom-bar {
      padding: 10px 16px calc(var(--safe-bottom) + 10px);
      display: flex;
      gap: 8px;
      align-items: center;
      border-top: 1px solid var(--border);
      background: rgba(13,15,26,0.95);
      backdrop-filter: blur(12px);
      flex-shrink: 0;
    }

    .btn-random {
      flex: 1;
      padding: 0 14px;
      height: 40px;
      border-radius: var(--radius);
      border: 1px solid var(--accent);
      background: var(--accent-dim);
      color: var(--accent);
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-random::before { content: ''; }
    .btn-random:active {
      transform: scale(0.98);
      background: var(--accent);
      color: var(--bg);
    }

    .btn-fav, .btn-filter-toggle {
      height: 40px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text-mid);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      flex-shrink: 0;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 0 14px;
    }
    .btn-fav .fav-icon { font-size: 14px; line-height: 1; }
    .btn-fav:active, .btn-filter-toggle:active { transform: scale(0.95); }
    .btn-fav.active { border-color: #f472b644; background: #f472b611; color: #f472b6; }
    .btn-filter-toggle .filter-label { font-size: 10px; font-weight: 600; letter-spacing: 1px; }
    .btn-filter-toggle.active {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-dim);
    }

    /* â”€â”€ FILTER SCREEN â”€â”€ */
    #screen-filter { padding: 18px; gap: 18px; }

    .filter-section { display: flex; flex-direction: column; gap: 8px; }

    .filter-title {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
      font-family: var(--font-mono);
    }
    .filter-title::before { content: '// '; color: var(--border); }

    .filter-chips { display: flex; flex-wrap: wrap; gap: 6px; }

    .filter-input {
      width: 100%;
      padding: 11px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text);
      background: var(--card);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      caret-color: var(--accent);
    }
    .filter-input::placeholder { color: var(--text-dim); }
    .filter-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-dim);
    }



    /* â”€â”€ STATS SCREEN â”€â”€ */
    #screen-stats { padding: 18px; gap: 16px; }

    .stats-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
    }

    .stats-card-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-dim);
      margin-bottom: 14px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: var(--font-mono);
    }
    .stats-card-title::before { content: '// '; color: var(--border); }

    .stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .stat-mini {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 12px;
      text-align: center;
    }
    .stat-mini .num {
      font-size: 26px;
      font-weight: 700;
      color: var(--accent);
      font-family: var(--font-mono);
      line-height: 1;
    }
    .stat-mini .lbl {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 5px;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-family: var(--font-mono);
    }

    canvas.chart-canvas { max-height: 220px; }


    /* â”€â”€ HISTORY SCREEN â”€â”€ */
    #screen-history { padding: 18px; gap: 10px; }

    .history-item {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px 12px 12px 14px;
      cursor: pointer;
      transition: border-color 0.15s;
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .history-item:active { border-color: var(--accent); }
    .history-item-body { flex: 1; min-width: 0; }
    .history-quote {
      font-family: var(--font-body);
      font-size: 14px;
      font-style: italic;
      font-weight: 300;
      color: var(--text);
      line-height: 1.6;
    }
    .history-author {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 6px;
      font-family: var(--font-mono);
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 4px;
    }
    .history-author-arrow { color: #ffffff; margin-right: 2px; }
    .history-cat-badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 3px;
      font-size: 10px;
      background: #6d1a2a18;
      color: #c0506a;
      border: 1px solid #c0506a33;
      font-style: normal;
      white-space: nowrap;
    }
    .history-fav-btn {
      flex-shrink: 0;
      width: 36px; height: 36px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--card);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      font-size: 18px;
      line-height: 1;
      align-self: center;
    }
    .history-fav-btn:active { transform: scale(0.9); }
    .history-fav-btn.active { border-color: #f472b644; background: #f472b611; }

    /* â”€â”€ BOTTOM NAV â”€â”€ */
    .bottom-nav {
      display: flex;
      border-top: 1px solid var(--border);
      background: rgba(13,15,26,0.97);
      padding-bottom: max(4px, calc(var(--safe-bottom) - 12px));
      flex-shrink: 0;
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 10px 0 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      transition: color 0.15s;
      -webkit-tap-highlight-color: transparent;
      position: relative;
    }
    .nav-btn .nav-icon { font-size: 18px; line-height: 1; }
    .nav-btn.active { color: var(--accent); }
    .nav-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0; left: 25%; right: 25%;
      height: 2px;
      background: var(--accent);
      border-radius: 1px;
      box-shadow: 0 0 8px var(--accent);
    }

    /* â”€â”€ EMPTY STATE â”€â”€ */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--text-dim);
      padding: 40px;
      text-align: center;
      font-family: var(--font-mono);
    }
    .empty-state .empty-icon { font-size: 40px; opacity: 0.5; }
    .empty-state p { font-size: 12px; line-height: 1.8; }

    /* â”€â”€ MODAL / SHEET â”€â”€ */
    .sheet-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.18);
      z-index: 100;
      backdrop-filter: blur(4px);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
    }
    .sheet-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .sheet {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 18px 18px 0 0;
      padding: 18px 18px calc(var(--safe-bottom) + 22px);
      transform: translateY(100%);
      transition: transform 0.38s cubic-bezier(0.32, 0.72, 0, 1);
      will-change: transform;
      max-height: 65vh;
      display: flex;
      flex-direction: column;
      touch-action: none;
    }
    .sheet-overlay.open .sheet {
      transform: translateY(0);
    }

    @keyframes sheetUp {
      from { transform: translateY(100%); }
      to   { transform: translateY(0); }
    }

    .sheet-handle {
      width: 32px; height: 3px;
      background: var(--border);
      border-radius: 2px;
      margin: 14px auto 10px;
      cursor: grab;
    }

    .sheet-title {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
      font-family: var(--font-mono);
      margin-bottom: 14px;
    }
    .sheet-title::before { content: '// '; color: var(--border); }

    .sheet-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      overflow-y: auto;
    }

    .sheet-item {
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--card);
      font-size: 13px;
      font-family: var(--font-body);
      font-style: italic;
      font-weight: 300;
      cursor: pointer;
      transition: all 0.12s;
      line-height: 1.5;
      color: var(--text);
    }
    .sheet-item:active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ DATA LOAD SCREEN â”€â”€ */
    .load-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 18px;
      padding: 32px 24px;
      text-align: center;
    }

    .load-title {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--text-dim);
      font-family: var(--font-mono);
    }
    .load-title::before { content: '// '; color: var(--border); }

    .load-spinner {
      width: 32px; height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ TOAST â”€â”€ */
    .toast {
      position: fixed;
      top: calc(var(--safe-top) + 72px); /* sous le header, au niveau du coin haut-gauche */
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--accent);
      padding: 9px 18px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-family: var(--font-mono);
      font-weight: 500;
      letter-spacing: 0.5px;
      opacity: 0;
      transition: all 0.22s;
      pointer-events: none;
      white-space: nowrap;
      z-index: 200;
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
    }
    .toast::before { content: '> '; color: #ffffff; }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* â”€â”€ SCROLLBAR â”€â”€ */
    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* â”€â”€ No data overlay â”€â”€ */
    #no-data-screen { display: none; }
    #no-data-screen.active { display: flex; }

    /* â”€â”€ ANIMATIONS â”€â”€ */
    @keyframes glitch {
      0%,100% { transform: translate(0); }
      20%      { transform: translate(-2px, 1px); }
      40%      { transform: translate(2px, -1px); }
      60%      { transform: translate(-1px, 2px); }
      80%      { transform: translate(1px, -2px); }
    }
    .quote-text.loading { animation: glitch 0.3s ease; opacity: 0.1; }

    /* â”€â”€ BOUTON FILTRE BOTTOM BAR â”€â”€ */
    /* â”€â”€ FILTER OVERLAY â”€â”€ */
    .filter-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.18);
      z-index: 100;
      backdrop-filter: blur(4px);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
    }
    .filter-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    /* Le panneau occupe 65vh max, slide up/down */
    .filter-menu {
      width: 100%;
      max-width: 480px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 18px 18px 0 0;
      display: flex;
      flex-direction: column;
      height: 65vh;
      transform: translateY(100%);
      transition: transform 0.38s cubic-bezier(0.32, 0.72, 0, 1);
      will-change: transform;
      touch-action: none;
    }
    .filter-overlay.open .filter-menu {
      transform: translateY(0);
    }

    /* Header fixe en haut, ne scroll pas */
    .filter-menu-header {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px 12px;
      border-bottom: 1px solid var(--border);
    }

    .filter-count-txt {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      font-family: var(--font-mono);
      letter-spacing: 0.5px;
    }

    .filter-reset {
      padding: 7px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 12px;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
      white-space: nowrap;
    }
    .filter-reset:hover { border-color: var(--border); color: var(--text-dim); }
    .filter-reset:active { border-color: var(--border); color: var(--text-dim); }
    .filter-reset.has-filters { border-color: #e05575; color: #e05575; }
    .filter-reset.has-filters:hover { background: #e0557520; border-color: #e05575; color: #e05575; }

    /* Body scrollable â€” prend tout l'espace restant */
    .filter-menu-body {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      padding: 10px 14px calc(var(--safe-bottom) + 24px);
      display: flex;
      flex-direction: column;
      gap: 6px;
      /* On laisse les enfants dÃ©finir leur propre hauteur â€” pas de overflow:hidden sur eux */
    }

    /* â”€â”€ CATÃ‰GORIES PLIABLES â”€â”€ */
    .filter-cat-section {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      /* PAS de overflow:hidden â€” sinon le contenu ouvert est coupÃ© */
      flex-shrink: 0;
    }

    .filter-cat-toggle {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 14px;
      background: var(--card);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-mid);
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: color 0.15s, background 0.15s;
      letter-spacing: 0.3px;
    }
    .filter-cat-toggle:active { color: var(--accent); }
    .filter-cat-toggle.has-active { color: var(--accent); background: var(--accent-dim); }
    .filter-cat-toggle.open { border-radius: var(--radius-sm) var(--radius-sm) 0 0; }

    .filter-cat-arrow {
      font-size: 10px;
      transition: transform 0.2s;
      color: var(--text-dim);
      flex-shrink: 0;
    }
    .filter-cat-toggle.open .filter-cat-arrow { transform: rotate(90deg); }

    /* Contenu pliable â€” display:none â†’ flex quand .open */
    .filter-collapsible {
      display: none;
      flex-wrap: wrap;
      gap: 6px;
      padding: 10px 12px 12px;
      background: var(--panel);
      border-top: 1px solid var(--border);
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    }
    .filter-collapsible.open { display: flex; }


  </style>
</head>
<body>

<div class="app" id="app">

  <!-- HEADER -->
  <header class="header">
    <span class="app-name" id="app-title">our quotes</span>
    <div class="header-actions">
      <button class="btn-fav-header" id="btn-fav-header" onclick="openHistorySheet()" title="Mes favoris">
        <span class="btn-fav-header-label">Mes phrases prÃ©fs</span>
        <span class="btn-fav-header-icon">ğŸ¤</span>
      </button>
    </div>
  </header>

  <!-- SCREEN : DATA LOAD -->
  <div class="screen active" id="no-data-screen">
    <div class="load-area">
      <div class="load-spinner"></div>
      <div class="load-title">loading data.json</div>
    </div>
  </div>

  <!-- SCREEN : QUOTE -->
  <div class="screen" id="screen-quote">
    <div class="quote-area">

      <!-- Zone centrale : citation -->
      <div class="quote-center" id="quote-center">
        <span class="quote-mark">"</span>
        <p class="quote-text" id="quote-text">Appuyez sur le bouton pour dÃ©couvrir une phrase.<span class="cursor-blink"></span></p>
      </div>

      <!-- Zone basse : auteur + badges + contexte -->
      <div class="quote-bottom" id="quote-bottom">
        <div class="quote-line-num" id="quote-line-num">phrase 001 / 000</div>
        <div class="quote-bottom-inner">
          <div class="quote-meta">
            <div class="meta-author" id="meta-author">â€”</div>
            <div class="meta-secondary" id="meta-secondary"></div>
          </div>
          <!-- Badges : Volume > CatÃ©gorie > Alcool > Voir contexte -->
          <div class="chips-row" id="chips-row"></div>
          <!-- DÃ©tails panel -->
          <div class="details-panel" id="details-panel"></div>
        </div>
      </div>

    </div>


    <!-- Bottom bar -->
    <div class="bottom-bar">
      <button class="btn-fav" id="btn-fav" onclick="toggleFav()" title="Ajouter aux favoris">
        <span class="fav-icon">ğŸ“Œ</span>
      </button>
      <button class="btn-random" onclick="showRandom()">MÃ©nestrel, une autre</button>
      <button class="btn-filter-toggle" id="btn-filter-toggle" onclick="toggleFilterMenu()" title="Filtres">ğŸ” <span class="filter-label">Filtrer</span></button>
    </div>
  </div>


  <!-- SCREEN : STATS -->
  <div class="screen" id="screen-stats">
    <div class="stats-card">
      <div class="stats-card-title">overview</div>
      <div class="stat-grid" id="stat-overview"></div>
    </div>
    <div class="stats-card">
      <div class="stats-card-title">phrases par personne</div>
      <canvas class="chart-canvas" id="chart-persons"></canvas>
    </div>
    <div class="stats-card">
      <div class="stats-card-title">catÃ©gories</div>
      <canvas class="chart-canvas" id="chart-cats"></canvas>
    </div>
    <div class="stats-card">
      <div class="stats-card-title">activitÃ© par heure</div>
      <canvas class="chart-canvas" id="chart-hours"></canvas>
    </div>
    <div class="stats-card">
      <div class="stats-card-title">top lieux</div>
      <canvas class="chart-canvas" id="chart-locations"></canvas>
    </div>
    <div class="stats-card">
      <div class="stats-card-title">phrases par volume</div>
      <canvas class="chart-canvas" id="chart-volumes"></canvas>
    </div>
  </div>

  <!-- SCREEN : HISTORY -->
  <div class="screen" id="screen-history">
    <div class="empty-state" id="history-empty">
      <div class="empty-icon">â—Œ</div>
      <p>// aucun historique<br>tirez des phrases alÃ©atoires<br>pour les voir apparaÃ®tre ici</p>
    </div>
    <div id="history-list" style="padding:18px;display:flex;flex-direction:column;gap:10px;"></div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav" id="bottom-nav">
    <button class="nav-btn active" onclick="navigate('quote')" id="nav-quote">
      <span class="nav-icon">ğŸ²</span>phrases
    </button>
    <button class="nav-btn" onclick="navigate('stats')" id="nav-stats">
      <span class="nav-icon">ğŸ“Š</span>stats
    </button>
    <button class="nav-btn" onclick="navigate('history')" id="nav-history">
      <span class="nav-icon">ğŸ’¾</span>log
    </button>
  </nav>

</div>


<!-- FILTER MENU OVERLAY -->
<div class="filter-overlay" id="filter-overlay" onclick="closeFilterMenu(event)">
  <div class="filter-menu" id="filter-menu">
    <div class="sheet-handle"></div>
    <div class="filter-menu-header">
      <div class="filter-count-txt" id="filter-count">â€” phrases</div>
      <button class="filter-reset" onclick="resetFilters()">ğŸ§¹ Supprimer les filtres</button>
    </div>
    <div class="filter-menu-body">
      <div class="filter-section">
        <div class="filter-title">Recherche</div>
        <input class="filter-input" type="search" placeholder="Rechercher par mot clÃ©" id="search-input" oninput="applyFilters()" />
      </div>
      <div class="filter-cat-section">
        <button class="filter-cat-toggle" onclick="toggleFilterCat('authors')">
          <span>ğŸ‘¤ Auteur</span><span class="filter-cat-arrow">â–¸</span>
        </button>
        <div class="filter-chips filter-collapsible" id="filter-authors"></div>
      </div>
      <div class="filter-cat-section">
        <button class="filter-cat-toggle" onclick="toggleFilterCat('main-cats')">
          <span>ğŸ· CatÃ©gorie principale</span><span class="filter-cat-arrow">â–¸</span>
        </button>
        <div class="filter-chips filter-collapsible" id="filter-main-cats"></div>
      </div>
      <div class="filter-cat-section">
        <button class="filter-cat-toggle" onclick="toggleFilterCat('second-cats')">
          <span>ğŸ”– CatÃ©gorie secondaire</span><span class="filter-cat-arrow">â–¸</span>
        </button>
        <div class="filter-chips filter-collapsible" id="filter-second-cats"></div>
      </div>
      <div class="filter-cat-section">
        <button class="filter-cat-toggle" onclick="toggleFilterCat('locations')">
          <span>ğŸ“ Lieu</span><span class="filter-cat-arrow">â–¸</span>
        </button>
        <div class="filter-chips filter-collapsible" id="filter-locations"></div>
      </div>
      <div class="filter-cat-section">
        <button class="filter-cat-toggle" onclick="toggleFilterCat('alcohol')">
          <span>ğŸº Alcool</span><span class="filter-cat-arrow">â–¸</span>
        </button>
        <div class="filter-chips filter-collapsible" id="filter-alcohol"></div>
      </div>
      <div class="filter-cat-section">
        <button class="filter-cat-toggle" onclick="toggleFilterCat('volumes')">
          <span>ğŸ“š Volume</span><span class="filter-cat-arrow">â–¸</span>
        </button>
        <div class="filter-chips filter-collapsible" id="filter-volumes"></div>
      </div>
    </div>
  </div>
</div>

<!-- FAVORITES SHEET -->
<div class="sheet-overlay" id="history-sheet" onclick="closeHistorySheet(event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">favoris</div>
    <div class="sheet-list" id="fav-list"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allQuotes = [];
let filteredQuotes = [];
let currentQuote = null;
let sessionHistory = [];
let favorites = JSON.parse(localStorage.getItem('qapp_favs') || '[]');
let activeFilters = { authors:[], mainCats:[], secondCats:[], locations:[], alcohol:[], volumes:[], search:'' };
let charts = {};
let dataLoaded = false;

// â”€â”€ XSS Protection â”€â”€
function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = String(str);
  return d.innerHTML;
}

// â”€â”€ Unique quote identifier (avoids collisions on identical text) â”€â”€
function quoteId(q) {
  return getCol(q, COL.quote) + '|||' + getCol(q, COL.name) + '|||' + getCol(q, COL.ts);
}

// Column mapping (flexible)
const COL = {
  ts:        ['Horodateur','horodateur','timestamp'],
  quote:     ['Insert quote','insert quote','Quote','quote','phrase'],
  name:      ['Insert name (e.g: John. D)','Insert name','name','auteur','Auteur'],
  location:  ['Insert location','Location','lieu','Lieu'],
  mainCat:   ['Main category','main category','CatÃ©gorie principale'],
  secondCat: ['Second category','second category','CatÃ©gorie secondaire'],
  alcohol:   ['Under alcohol ?','Under alcohol','alcool','Alcool'],
  context:   ['Context','context','Contexte'],
  wam:       ['Si wam, avec qui ?','Si wam','wam'],
  volume:    ['Volume','volume','Vol','vol'],
};

function getCol(row, keys) {
  for (const k of keys) {
    if (row[k] !== undefined && row[k] !== null && row[k] !== '') return row[k];
  }
  // Case insensitive fallback
  const rowLower = Object.fromEntries(Object.entries(row).map(([k,v])=>[k.toLowerCase(),v]));
  for (const k of keys) {
    if (rowLower[k.toLowerCase()] !== undefined) return rowLower[k.toLowerCase()];
  }
  return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATE PARSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseDate(str) {
  if (!str) return null;
  str = String(str).trim();
  // DD/MM/YYYY HH:MM:SS or DD/MM/YYYY HH:MM
  let m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})[\s,T](\d{2}):(\d{2})/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1], +m[4], +m[5]);
  // ISO
  const d = new Date(str);
  return isNaN(d) ? null : d;
}

function formatDate(str) {
  const d = parseDate(str);
  if (!d) return str;
  return d.toLocaleDateString('fr-FR', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA LOADING â€” fetch depuis GitHub Pages
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Charge data.json automatiquement au dÃ©marrage (chemin relatif GitHub Pages)
async function fetchData() {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 10000); // 10s timeout
  try {
    const res = await fetch('./data.json', { signal: controller.signal });
    clearTimeout(timeout);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    initData(Array.isArray(data) ? data : data.data || []);
  } catch (err) {
    clearTimeout(timeout);
    console.warn('data.json introuvable ou invalide :', err);
    showLoadError(err.name === 'AbortError'
      ? 'Timeout â€” le chargement prend trop de temps.'
      : 'Impossible de charger data.json. VÃ©rifiez votre dÃ©ploiement.');
  }
}

function showLoadError(msg) {
  const screen = document.getElementById('no-data-screen');
  const area = screen.querySelector('.load-area');
  if (!area) return;
  area.innerHTML =
    '<div style="font-size:32px;opacity:0.5">âš </div>' +
    '<div class="load-title">' + esc(msg) + '</div>' +
    '<button onclick="location.reload()" style="margin-top:8px;padding:10px 20px;border-radius:var(--radius-sm);border:1px solid var(--accent);background:var(--accent-dim);color:var(--accent);font-family:var(--font-mono);font-size:12px;cursor:pointer;letter-spacing:1px">â†» RÃ©essayer</button>';
}

function initData(data) {
  allQuotes = data.filter(r => getCol(r, COL.quote));
  filteredQuotes = [...allQuotes];
  dataLoaded = true;

  document.getElementById('no-data-screen').classList.remove('active');
  document.getElementById('bottom-nav').style.display = '';
  navigate('quote');
  buildFilters();
  buildQueue();
  showRandom();
  showToast(`${allQuotes.length} phrases chargÃ©es`);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hideAllScreens() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
}

function navigate(screen) {
  if (!dataLoaded && screen !== 'load') return;
  hideAllScreens();
  document.getElementById('screen-' + screen).classList.add('active');
  const navBtn = document.getElementById('nav-' + screen);
  if (navBtn) navBtn.classList.add('active');

  if (screen === 'stats') buildStats();
  if (screen === 'history') renderHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUOTE DISPLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// File de lecture mÃ©langÃ©e : chaque phrase est jouÃ©e une fois avant de recommencer
let shuffleQueue = [];

function buildQueue() {
  // Fisher-Yates shuffle sur une copie de filteredQuotes
  shuffleQueue = [...filteredQuotes];
  for (let i = shuffleQueue.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffleQueue[i], shuffleQueue[j]] = [shuffleQueue[j], shuffleQueue[i]];
  }
}

function showRandom() {
  if (!filteredQuotes.length) {
    showToast('Aucune phrase avec ces filtres');
    return;
  }
  if (!shuffleQueue.length) { buildQueue(); }
  displayQuote(shuffleQueue.pop());
}

function displayQuote(q) {
  currentQuote = q;

  // NumÃ©ro de phrase (zone haute â€” fixe, pas animÃ©e)
  const qIdx = filteredQuotes.indexOf(q) + 1 || '?';
  const lineEl = document.getElementById('quote-line-num');
  if (lineEl) lineEl.textContent = 'phrase ' + String(qIdx).padStart(3,'0') + ' / ' + String(filteredQuotes.length).padStart(3,'0');

  const centerEl = document.getElementById('quote-center');
  const bottomEl = document.getElementById('quote-bottom');

  // Retirer l'animation prÃ©cÃ©dente si en cours
  centerEl.classList.remove('animating');
  bottomEl.classList.remove('animating');

  // Forcer reflow pour relancer l'animation
  void centerEl.offsetWidth;

  // Mettre Ã  jour le contenu
  const el = document.getElementById('quote-text');
  el.innerHTML = esc(getCol(q, COL.quote)) + '<span class="cursor-blink"></span>';

  const name = getCol(q, COL.name);
  const loc  = getCol(q, COL.location);
  const ts   = getCol(q, COL.ts);

  document.getElementById('meta-author').textContent = name ? 'â€” ' + name : 'â€”';

  const secEl = document.getElementById('meta-secondary');
  secEl.innerHTML = '';
  if (loc) secEl.innerHTML += '<span>' + esc(loc) + '</span>';
  if (ts)  secEl.innerHTML += '<span>' + esc(formatDate(ts)) + '</span>';

  // Build chips (ordre : Volume > CatÃ©gorie > Alcool > Contexte)
  buildChips(q);

  // Lancer l'animation
  centerEl.classList.add('animating');
  bottomEl.classList.add('animating');

  // Add to history
  sessionHistory.unshift(q);
  if (sessionHistory.length > 50) sessionHistory.pop();

  // Fav state
  updateFavBtn();
}

function buildChips(q) {
  const row   = document.getElementById('chips-row');
  const panel = document.getElementById('details-panel');
  row.innerHTML   = '';
  panel.innerHTML = '';
  panel.classList.remove('open');

  const ctx       = getCol(q, COL.context);
  const mainCat   = getCol(q, COL.mainCat);
  const secondCat = getCol(q, COL.secondCat);
  const alcohol   = getCol(q, COL.alcohol);
  const volume    = getCol(q, COL.volume);

  if (!ctx && !mainCat && !secondCat && !alcohol && !volume) return;

  // â”€â”€ Badge Volume (seul badge visible) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (volume) {
    const badge = document.createElement('span');
    badge.className = 'info-badge vol-badge';
    badge.textContent = 'ğŸ“š ' + volume;
    row.appendChild(badge);
  }

  // â”€â”€ Bouton "voir le contexte" (si contexte, catÃ©gorie ou alcool dispo) â”€â”€
  const hasDetails = ctx || mainCat || secondCat || alcohol;
  if (hasDetails) {
    const masterChip = document.createElement('button');
    masterChip.className = 'chip';
    masterChip.innerHTML = `<span>â†“</span> voir le contexte`;
    masterChip.onclick = () => {
      const open = panel.classList.toggle('open');
      masterChip.classList.toggle('active', open);
      masterChip.innerHTML = open
        ? `<span>â†‘</span> masquer`
        : `<span>â†“</span> voir le contexte`;
    };
    row.appendChild(masterChip);

    // â”€â”€ Panel : badges catÃ©gorie/alcool, puis contexte texte â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const hasBadges = mainCat || alcohol;
    if (hasBadges) {
      const badgeRow = document.createElement('div');
      badgeRow.className = 'chips-row';
      badgeRow.style.cssText = 'margin-bottom:8px;';
      if (mainCat) {
        const cat = mainCat + (secondCat ? ' Â· ' + secondCat : '');
        const b = document.createElement('span');
        b.className = 'info-badge cat-badge';
        b.textContent = cat;
        badgeRow.appendChild(b);
      }
      if (alcohol) {
        const isYes = /oui|yes|true/i.test(alcohol);
        const b = document.createElement('span');
        b.className = 'info-badge alc-badge ' + (isYes ? 'yes' : 'no');
        b.textContent = isYes ? 'ğŸº avec alcool' : 'ğŸƒ sans alcool';
        badgeRow.appendChild(b);
      }
      panel.appendChild(badgeRow);
    }
    if (ctx) {
      const r = document.createElement('div');
      r.className = 'detail-row';
      r.innerHTML = `<span class="detail-label">Contexte</span><span class="detail-value">${esc(ctx)}</span>`;
      panel.appendChild(r);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FAVORITES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Shared favorite toggle helper â”€â”€
function setFavorite(q) {
  const qid = quoteId(q);
  const idx = favorites.findIndex(f => quoteId(f) === qid);
  const added = idx === -1;
  if (added) {
    favorites.push(q);
  } else {
    favorites.splice(idx, 1);
  }
  localStorage.setItem('qapp_favs', JSON.stringify(favorites));
  updateFavBtn();
  showToast(added ? 'â™¥ï¸ AjoutÃ© aux favoris' : 'RetirÃ© des favoris');
  return added;
}

function toggleFav() {
  if (!currentQuote) return;
  setFavorite(currentQuote);
}

function updateFavBtn() {
  if (!currentQuote) return;
  const qid = quoteId(currentQuote);
  const isFav = favorites.some(f => quoteId(f) === qid);
  const btn = document.getElementById('btn-fav');
  btn.classList.toggle('active', isFav);
  const icon = btn.querySelector('.fav-icon');
  if (icon) icon.textContent = isFav ? 'â™¥ï¸' : 'ğŸ“Œ';
  // Bouton header : affiche â™¥ï¸ si au moins 1 favori
  const btnHeader = document.getElementById('btn-fav-header');
  if (btnHeader) {
    const hIcon = btnHeader.querySelector('.btn-fav-header-icon');
    if (hIcon) hIcon.textContent = favorites.length > 0 ? 'â™¥ï¸' : 'ğŸ¤';
  }
}

function openHistorySheet() {
  const list = document.getElementById('fav-list');
  list.innerHTML = '';
  if (!favorites.length) {
    list.innerHTML = '<p style="color:var(--ink-light);font-size:14px;text-align:center;padding:20px">Aucun favori pour l\'instant</p>';
  } else {
    favorites.forEach(q => {
      const item = document.createElement('div');
      item.className = 'sheet-item';
      item.textContent = getCol(q, COL.quote);
      item.onclick = () => { displayQuote(q); navigate('quote'); closeHistorySheetSmooth(); };
      list.appendChild(item);
    });
  }
  document.getElementById('history-sheet').classList.add('open');
}

function closeHistorySheetSmooth() {
  const overlay = document.getElementById('history-sheet');
  const sheet = overlay.querySelector('.sheet');
  sheet.style.transform = '';
  overlay.classList.remove('open');
}

function closeHistorySheet(e) {
  if (!e || e.target === document.getElementById('history-sheet')) {
    closeHistorySheetSmooth();
  }
}

// â”€â”€ Swipe-down to dismiss favorites sheet â”€â”€
(function initFavSheetDrag() {
  let startY = 0, currentY = 0, dragging = false;
  const getSheet = () => document.querySelector('#history-sheet .sheet');
  const getOverlay = () => document.getElementById('history-sheet');

  function onStart(e) {
    const overlay = getOverlay();
    if (!overlay.classList.contains('open')) return;
    const sheet = getSheet();
    const rect = sheet.getBoundingClientRect();
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    if (clientY < rect.top || clientY > rect.top + 48) return;
    dragging = true;
    startY = clientY;
    currentY = clientY;
    sheet.style.transition = 'none';
  }

  function onMove(e) {
    if (!dragging) return;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    currentY = clientY;
    const dy = Math.max(0, currentY - startY);
    getSheet().style.transform = `translateY(${dy}px)`;
    const overlay = getOverlay();
    const progress = Math.min(dy / 300, 1);
    overlay.style.background = `rgba(0,0,0,${0.18 * (1 - progress)})`;
    if (e.cancelable) e.preventDefault();
  }

  function onEnd() {
    if (!dragging) return;
    dragging = false;
    const dy = currentY - startY;
    const sheet = getSheet();
    const overlay = getOverlay();
    sheet.style.transition = '';
    overlay.style.background = '';
    if (dy > 100) {
      closeHistorySheetSmooth();
    } else {
      sheet.style.transform = '';
    }
  }

  document.addEventListener('touchstart', onStart, { passive: true });
  document.addEventListener('touchmove', onMove, { passive: false });
  document.addEventListener('touchend', onEnd);
  document.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistory() {
  const list = document.getElementById('history-list');
  const empty = document.getElementById('history-empty');
  list.innerHTML = '';
  if (!sessionHistory.length) { empty.style.display = 'flex'; return; }
  empty.style.display = 'none';
  sessionHistory.forEach(q => {
    const item = document.createElement('div');
    item.className = 'history-item';

    const quoteKey = getCol(q, COL.quote);
    const qid = quoteId(q);
    const isFav = favorites.some(f => quoteId(f) === qid);
    const name  = getCol(q, COL.name) || '?';
    const loc   = getCol(q, COL.location) || '';
    const cat   = getCol(q, COL.mainCat) || '';

    const catHtml = cat ? ` <span class="history-cat-badge">${esc(cat)}</span>` : '';

    item.innerHTML =
      '<button class="history-fav-btn' + (isFav ? ' active' : '') + '" title="Favori"><span class="fav-icon">' + (isFav ? 'â™¥ï¸' : 'ğŸ“Œ') + '</span></button>' +
      '<div class="history-item-body">' +
        '<div class="history-quote">' + esc(quoteKey) + '</div>' +
        '<div class="history-author"><span class="history-author-arrow">></span>' + esc(name) + ' Â· ' + esc(loc) + catHtml + '</div>' +
      '</div>';

    // Clic sur le bouton favori
    const favBtn = item.querySelector('.history-fav-btn');
    favBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const added = setFavorite(q);
      favBtn.innerHTML = '<span class="fav-icon">' + (added ? 'â™¥ï¸' : 'ğŸ“Œ') + '</span>';
      favBtn.classList.toggle('active', added);
    });

    // Clic sur l'item = afficher la phrase
    item.addEventListener('click', () => { displayQuote(q); navigate('quote'); });
    list.appendChild(item);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildFilters() {
  const uniq = (key) => [...new Set(allQuotes.map(q => getCol(q, key)).filter(Boolean))].sort();

  buildChipFilter('filter-authors', uniq(COL.name), 'authors');
  buildChipFilter('filter-main-cats', uniq(COL.mainCat), 'mainCats');
  buildChipFilter('filter-second-cats', uniq(COL.secondCat), 'secondCats');
  buildChipFilter('filter-locations', uniq(COL.location), 'locations');
  buildChipFilter('filter-alcohol', uniq(COL.alcohol), 'alcohol');
  buildChipFilter('filter-volumes', uniq(COL.volume), 'volumes');
}

function buildChipFilter(containerId, values, filterKey) {
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  values.forEach(v => {
    const chip = document.createElement('button');
    chip.className = 'chip';
    chip.textContent = v;
    chip.onclick = () => {
      chip.classList.toggle('active');
      const arr = activeFilters[filterKey];
      const idx = arr.indexOf(v);
      if (idx === -1) arr.push(v); else arr.splice(idx, 1);
      applyFilters();
    };
    el.appendChild(chip);
  });
}

function applyFilters() {
  activeFilters.search = document.getElementById('search-input').value.toLowerCase();
  filteredQuotes = allQuotes.filter(q => {
    if (activeFilters.authors.length && !activeFilters.authors.includes(getCol(q, COL.name))) return false;
    if (activeFilters.mainCats.length && !activeFilters.mainCats.includes(getCol(q, COL.mainCat))) return false;
    if (activeFilters.secondCats.length && !activeFilters.secondCats.includes(getCol(q, COL.secondCat))) return false;
    if (activeFilters.locations.length && !activeFilters.locations.includes(getCol(q, COL.location))) return false;
    if (activeFilters.alcohol.length && !activeFilters.alcohol.includes(getCol(q, COL.alcohol))) return false;
    if (activeFilters.volumes.length && !activeFilters.volumes.includes(getCol(q, COL.volume))) return false;
    if (activeFilters.search) {
      const haystack = (getCol(q, COL.quote) + ' ' + getCol(q, COL.context)).toLowerCase();
      if (!haystack.includes(activeFilters.search)) return false;
    }
    return true;
  });
  buildQueue();
  updateFilterCount();
  updateFilterBtnState();
  refreshFilterCatStates();
}

function resetFilters() {
  activeFilters = { authors:[], mainCats:[], secondCats:[], locations:[], alcohol:[], volumes:[], search:'' };
  // Vider la recherche
  const si = document.getElementById('search-input');
  if (si) si.value = '';
  // DÃ©sÃ©lectionner tous les chips du panneau filtre overlay
  document.querySelectorAll('.filter-collapsible .chip').forEach(c => c.classList.remove('active'));
  // Retirer l'Ã©tat actif des boutons de catÃ©gorie
  document.querySelectorAll('.filter-cat-toggle').forEach(t => t.classList.remove('has-active'));
  // Remettre toutes les phrases
  filteredQuotes = [...allQuotes];
  buildQueue();
  updateFilterCount();
  updateFilterBtnState();
  localStorage.removeItem('qapp_filters');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHART_COLORS = ['#7c6af7','#4ade80','#f472b6','#22d3ee','#fbbf24','#a78bfa','#34d399','#fb7185'];

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

let _chartJsLoaded = false;
async function loadChartJS() {
  if (_chartJsLoaded) return;
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
    s.onload = () => { _chartJsLoaded = true; resolve(); };
    s.onerror = () => reject(new Error('Chart.js failed to load'));
    document.head.appendChild(s);
  });
}

async function buildStats() {
  if (!allQuotes.length) return;

  // Lazy-load Chart.js on first Stats visit
  if (!_chartJsLoaded) {
    try {
      await loadChartJS();
    } catch (e) {
      console.warn(e);
      showToast('Impossible de charger les graphiques');
      return;
    }
  }

  // Overview
  const alcoholCount = allQuotes.filter(q => /oui|yes|true/i.test(getCol(q, COL.alcohol))).length;
  const uniqAuthors = new Set(allQuotes.map(q=>getCol(q,COL.name))).size;
  // CatÃ©gorie la plus reprÃ©sentÃ©e (2Ã¨me rÃ©sultat de mainCat, prÃ©sentÃ© comme #1)
  const catFreq = {};
  allQuotes.forEach(q => { const c = getCol(q,COL.mainCat); if (c) catFreq[c]=(catFreq[c]||0)+1; });
  const overviewCatSorted = Object.entries(catFreq).sort((a,b)=>b[1]-a[1]);
  const topCatName = overviewCatSorted.length >= 2 ? overviewCatSorted[1][0] : (overviewCatSorted[0] ? overviewCatSorted[0][0] : 'â€”');

  document.getElementById('stat-overview').innerHTML =
    '<div class="stat-mini"><div class="num">' + allQuotes.length + '</div><div class="lbl">Phrases</div></div>' +
    '<div class="stat-mini"><div class="num">' + uniqAuthors + '</div><div class="lbl">Auteurs</div></div>' +
    '<div class="stat-mini"><div class="num">' + alcoholCount + '</div><div class="lbl">Avec alcool</div></div>' +
    '<div class="stat-mini"><div class="num" style="font-size:14px;line-height:1.2">' + esc(topCatName) + '</div><div class="lbl">CatÃ©gorie #1</div></div>';

  // Persons chart â€” top 10
  const personCounts = {};
  allQuotes.forEach(q => { const n = getCol(q,COL.name)||'?'; personCounts[n] = (personCounts[n]||0)+1; });
  const personSorted = Object.entries(personCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
  destroyChart('persons');
  charts.persons = new Chart(document.getElementById('chart-persons'), {
    type: 'bar',
    data: { labels: personSorted.map(e=>e[0]), datasets:[{ data: personSorted.map(e=>e[1]), backgroundColor: CHART_COLORS, borderRadius:8, borderSkipped:false }]},
    options: chartOpts('Phrases')
  });

  // Main cats â€” sans contour + pourcentages dans le donut
  const catCounts = {};
  allQuotes.forEach(q => { const c = getCol(q,COL.mainCat)||'Autre'; catCounts[c]=(catCounts[c]||0)+1; });
  const catSorted = Object.entries(catCounts).sort((a,b)=>b[1]-a[1]);
  const catTotal = catSorted.reduce((s,e)=>s+e[1],0);
  destroyChart('cats');
  // Plugin inline pour afficher les % dans le donut
  const doughnutPctPlugin = {
    id: 'doughnutPct',
    afterDatasetsDraw(chart) {
      const { ctx, data } = chart;
      const total = data.datasets[0].data.reduce((s,v)=>s+v,0);
      ctx.save();
      data.datasets[0].data.forEach((val, i) => {
        const meta = chart.getDatasetMeta(0);
        const arc  = meta.data[i];
        if (!arc) return;
        const pct = Math.round(val / total * 100);
        if (pct < 4) return; // skip tiny slices
        const angle = (arc.startAngle + arc.endAngle) / 2;
        const r = (arc.innerRadius + arc.outerRadius) / 2;
        const x = arc.x + Math.cos(angle) * r;
        const y = arc.y + Math.sin(angle) * r;
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 10px JetBrains Mono, monospace';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(pct + '%', x, y);
      });
      ctx.restore();
    }
  };
  charts.cats = new Chart(document.getElementById('chart-cats'), {
    type: 'doughnut',
    data: { labels: catSorted.map(e=>e[0]), datasets:[{ data: catSorted.map(e=>e[1]), backgroundColor: CHART_COLORS, borderWidth:0, borderColor:'transparent', hoverOffset:6 }]},
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position:'right', labels:{ font:{family:'JetBrains Mono',size:10}, color:'#8b8fac', boxWidth:10, padding:10 }},
        tooltip: { callbacks: { label: function(ctx) {
          const pct = Math.round(ctx.raw / catTotal * 100);
          return ' ' + ctx.label + ': ' + ctx.raw + ' (' + pct + '%)';
        }}}
      }
    },
    plugins: [doughnutPctPlugin]
  });

  // Hours
  const hourCounts = Array(24).fill(0);
  allQuotes.forEach(q => { const d = parseDate(getCol(q,COL.ts)); if(d) hourCounts[d.getHours()]++; });
  destroyChart('hours');
  charts.hours = new Chart(document.getElementById('chart-hours'), {
    type: 'line',
    data: { labels: Array.from({length:24},(_,i)=>`${i}h`), datasets:[{ data:hourCounts, borderColor:'#5b4ff5', backgroundColor:'rgba(91,79,245,0.1)', fill:true, tension:0.4, pointRadius:3, pointBackgroundColor:'#5b4ff5' }]},
    options: chartOpts('Phrases')
  });

  // Locations
  const locCounts = {};
  allQuotes.forEach(q => {
    const l = getCol(q,COL.location)||'?';
    if (!/no data/i.test(l)) locCounts[l]=(locCounts[l]||0)+1;
  });
  const locSorted = Object.entries(locCounts).sort((a,b)=>b[1]-a[1]).slice(0,7);
  destroyChart('locations');
  charts.locations = new Chart(document.getElementById('chart-locations'), {
    type: 'bar',
    data: { labels: locSorted.map(e=>e[0]), datasets:[{ data:locSorted.map(e=>e[1]), backgroundColor: CHART_COLORS, borderRadius:8, borderSkipped:false }]},
    options: { ...chartOpts('Phrases'), indexAxis:'y' }
  });

  // Volumes
  const volCounts = {};
  allQuotes.forEach(q => { const v = getCol(q,COL.volume); if(v) volCounts[v]=(volCounts[v]||0)+1; });
  if (Object.keys(volCounts).length) {
    const volSorted = Object.entries(volCounts).sort((a,b)=>{
      const na = parseInt(a[0])||0, nb = parseInt(b[0])||0;
      return na - nb || a[0].localeCompare(b[0]);
    });
    destroyChart('volumes');
    charts.volumes = new Chart(document.getElementById('chart-volumes'), {
      type: 'bar',
      data: { labels: volSorted.map(e=>e[0]), datasets:[{ data:volSorted.map(e=>e[1]), backgroundColor: CHART_COLORS, borderRadius:8, borderSkipped:false }]},
      options: chartOpts('Phrases')
    });
  }

}

function chartOpts(yLabel) {
  return {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: { display: false },
      tooltip: { callbacks: { label: ctx => ` ${ctx.raw} phrase${ctx.raw > 1 ? 's' : ''}` } }
    },
    scales: {
      x: { grid: { color:'rgba(255,255,255,0.04)' }, ticks: { font:{family:'JetBrains Mono',size:10}, color:'#4a4f6a' } },
      y: { grid: { color:'rgba(255,255,255,0.04)' }, ticks: { font:{family:'JetBrains Mono',size:10}, color:'#4a4f6a' } }
    }
  };
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTER MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openFilterMenu() {
  const overlay = document.getElementById('filter-overlay');
  const btn = document.getElementById('btn-filter-toggle');
  overlay.classList.add('open');
  btn.classList.add('active');
  updateFilterCount();
}

function closeFilterMenuSmooth() {
  const overlay = document.getElementById('filter-overlay');
  const btn = document.getElementById('btn-filter-toggle');
  const menu = overlay.querySelector('.filter-menu');
  // Reset any drag transform â€” let CSS transition handle close
  menu.style.transform = '';
  overlay.classList.remove('open');
  btn.classList.remove('active');
}

function toggleFilterMenu() {
  const overlay = document.getElementById('filter-overlay');
  overlay.classList.contains('open') ? closeFilterMenuSmooth() : openFilterMenu();
}

function closeFilterMenu(e) {
  if (e.target === document.getElementById('filter-overlay')) {
    closeFilterMenuSmooth();
  }
}

// â”€â”€ Swipe-down to dismiss filter panel â”€â”€
(function initFilterDrag() {
  let startY = 0, currentY = 0, dragging = false;
  const getMenu = () => document.querySelector('.filter-menu');
  const getOverlay = () => document.getElementById('filter-overlay');

  function onStart(e) {
    const overlay = getOverlay();
    if (!overlay.classList.contains('open')) return;
    const menu = getMenu();
    // Only start drag if touch is on the handle area (top 48px of panel)
    const rect = menu.getBoundingClientRect();
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    if (clientY < rect.top || clientY > rect.top + 48) return;
    dragging = true;
    startY = clientY;
    currentY = clientY;
    menu.style.transition = 'none';
  }

  function onMove(e) {
    if (!dragging) return;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    currentY = clientY;
    const dy = Math.max(0, currentY - startY);
    const menu = getMenu();
    menu.style.transform = `translateY(${dy}px)`;
    // Fade backdrop proportionally
    const overlay = getOverlay();
    const progress = Math.min(dy / 300, 1);
    overlay.style.background = `rgba(0,0,0,${0.18 * (1 - progress)})`;
    if (e.cancelable) e.preventDefault();
  }

  function onEnd() {
    if (!dragging) return;
    dragging = false;
    const dy = currentY - startY;
    const menu = getMenu();
    const overlay = getOverlay();
    menu.style.transition = '';
    overlay.style.background = '';
    if (dy > 100) {
      closeFilterMenuSmooth();
    } else {
      menu.style.transform = '';
    }
  }

  document.addEventListener('touchstart', onStart, { passive: true });
  document.addEventListener('touchmove', onMove, { passive: false });
  document.addEventListener('touchend', onEnd);
  document.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
})();

function updateFilterCount() {
  const el = document.getElementById('filter-count');
  if (!el) return;
  const n = activeFilters.authors.length + activeFilters.mainCats.length +
    activeFilters.secondCats.length + activeFilters.locations.length +
    activeFilters.alcohol.length + activeFilters.volumes.length + (activeFilters.search ? 1 : 0);
  el.textContent = n === 0 ? 'Aucun filtre actif' : `${n} filtre${n > 1 ? 's' : ''} actif${n > 1 ? 's' : ''}`;
}

function toggleFilterCat(id) {
  const chips  = document.getElementById('filter-' + id);
  const toggle = chips ? chips.previousElementSibling : null;
  if (!chips || !toggle) return;
  const isOpen = chips.classList.toggle('open');
  toggle.classList.toggle('open', isOpen);
  // Reflet actif
  updateFilterCatState(id, toggle);
}

function updateFilterCatState(id, toggle) {
  if (!toggle) return;
  const keyMap = {
    'authors': 'authors', 'main-cats': 'mainCats',
    'second-cats': 'secondCats', 'locations': 'locations', 'alcohol': 'alcohol', 'volumes': 'volumes'
  };
  const key = keyMap[id];
  const hasActive = key && activeFilters[key] && activeFilters[key].length > 0;
  toggle.classList.toggle('has-active', hasActive);
}

function refreshFilterCatStates() {
  ['authors','main-cats','second-cats','locations','alcohol','volumes'].forEach(id => {
    const chips  = document.getElementById('filter-' + id);
    const toggle = chips ? chips.previousElementSibling : null;
    updateFilterCatState(id, toggle);
  });
}


function loadSavedFilters() {
  const saved = localStorage.getItem('qapp_filters');
  if (!saved) return;
  try {
    activeFilters = JSON.parse(saved);
    if (activeFilters.search) {
      const si = document.getElementById('search-input');
      if (si) si.value = activeFilters.search;
    }
    applyFilters();
    // Re-highlight chips
    setTimeout(() => {
      syncFilterChips();
      updateFilterBtnState();
    }, 50);
  } catch(e) {}
}

function syncFilterChips() {
  document.querySelectorAll('#filter-authors .chip').forEach(c => {
    c.classList.toggle('active', activeFilters.authors.includes(c.textContent));
  });
  document.querySelectorAll('#filter-main-cats .chip').forEach(c => {
    c.classList.toggle('active', activeFilters.mainCats.includes(c.textContent));
  });
  document.querySelectorAll('#filter-second-cats .chip').forEach(c => {
    c.classList.toggle('active', activeFilters.secondCats.includes(c.textContent));
  });
  document.querySelectorAll('#filter-locations .chip').forEach(c => {
    c.classList.toggle('active', activeFilters.locations.includes(c.textContent));
  });
  document.querySelectorAll('#filter-alcohol .chip').forEach(c => {
    c.classList.toggle('active', activeFilters.alcohol.includes(c.textContent));
  });
  document.querySelectorAll('#filter-volumes .chip').forEach(c => {
    c.classList.toggle('active', activeFilters.volumes.includes(c.textContent));
  });
}

function updateFilterBtnState() {
  const hasFilter = activeFilters.authors.length || activeFilters.mainCats.length ||
    activeFilters.secondCats.length || activeFilters.locations.length ||
    activeFilters.alcohol.length || activeFilters.volumes.length || activeFilters.search;
  const btn = document.getElementById('btn-filter-toggle');
  if (btn) btn.classList.toggle('active', !!hasFilter);
  const rst = document.querySelector('.filter-reset');
  if (rst) rst.classList.toggle('has-filters', !!hasFilter);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  // Nav masquÃ©e pendant le chargement
  document.getElementById('bottom-nav').style.display = 'none';
  document.getElementById('no-data-screen').classList.add('active');

  // Charge data.json depuis GitHub Pages
  fetchData();

  // PWA service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  }

  // Raccourci clavier : espace / entrÃ©e â†’ phrase suivante
  document.addEventListener('keydown', e => {
    if (e.key === ' ' || e.key === 'Enter') showRandom();
  });
});
</script>
<script>
  document.addEventListener('selectstart', e => e.preventDefault());
  document.addEventListener('contextmenu', e => e.preventDefault());
</script>
</body>
</html>
